import { Component } from '@angular/core';
import { CollectionUtils, SecurityUtils, CrudUtils } from '../../../utility';
//extends ModalInterfaceComponent
export class CrudListComponentInterface {
    constructor() {
        this.keyMap = new Array();
        // super();
    }
    ngOnInit() {
        this.setCommonConfig();
        this.setListConfig();
    }
    setCommonConfig() {
    }
    setListConfig() {
    }
    setBadges() {
        return null;
    }
    setCommonConfigUsingCrud(crud) {
        //  Config
        this.identifier = crud.identifier;
        this.header = crud.header;
        //  Tab wise data/setting
        //this.keyMap = {};
        this.listReset = true;
    }
    setListConfigUsingCrud(crud) {
        //  Config
        this.quickLinks = crud.quickLinks;
        this.searchConfig = crud.search;
        this.listConfig = crud.list;
        this.actions = crud.actions;
        this.setConfigListData([], []);
    }
    loadFilterParams(filterStr) {
        if (filterStr != null) {
            const filter = SecurityUtils.decrypt(filterStr);
            this.configListData.searchData = filter;
        }
        else {
        }
        this.configListData.pageNo = 1;
    }
    setConfigListData(records, badges, route) {
        let configListDataNew = {
            pageBackRoute: route,
            badges: badges,
            records: records,
            originalData: this.originalData
        };
        this.configListData = Object.assign(Object.assign({}, this.configListData), configListDataNew);
    }
    getRowKey(lIndex) {
        let keys;
        if (this.listConfig && this.listConfig.lists && this.listConfig.lists[lIndex]) {
            keys = this.listConfig.lists[lIndex].uniqueKeys;
        }
        else {
            keys = new Array();
        }
        return keys;
    }
    getChildRowKey(lIndex) {
        let keys;
        if (this.listConfig && this.listConfig.lists && this.listConfig.lists[lIndex] && this.listConfig.lists[lIndex].child && this.listConfig.lists[lIndex].child.record && this.listConfig.lists[lIndex].child.record.uniqueKeys) {
            keys = this.listConfig.lists[lIndex].child.record.uniqueKeys;
        }
        else {
            keys = new Array();
        }
        return keys;
    }
    getChildRecordIdentifier(lIndex) {
        let childRecordIdentifier;
        if (this.listConfig && this.listConfig.lists && this.listConfig.lists[lIndex] && this.listConfig.lists[lIndex].child) {
            childRecordIdentifier = this.listConfig.lists[lIndex].child.recordIdentifier;
        }
        else {
            childRecordIdentifier = "";
        }
        return childRecordIdentifier;
    }
    beforeChangeMerge(action, sourceIdentifier) {
        let rows;
        let rowIndex = -1;
        if (this.configListData && this.configListData.records) {
            for (let lIndex = 0; lIndex < this.configListData.records.length; lIndex++) {
                if (this.listConfig.lists[lIndex].identifier == sourceIdentifier) {
                    for (let rIndex = 0; rIndex < this.configListData.records[lIndex].rows.length; rIndex++) {
                        let keys = this.getRowKey(lIndex);
                        let isMatchingRow = true;
                        for (let key of keys) {
                            if (this.configListData.records[lIndex].rows[rIndex][key] != action.originalData[key]) {
                                isMatchingRow = false;
                            }
                        }
                        if (isMatchingRow) {
                            this.configListData.records[lIndex].rows[rIndex] = Object.assign(Object.assign({}, action.originalData), action.data);
                            rows = this.configListData.records[lIndex].rows;
                            rowIndex = rIndex;
                            break;
                        }
                    }
                }
            }
        }
        return { rows: rows, rowIndex: rowIndex };
    }
    addRow(action, sourceIdentifier, data) {
        let rows;
        let rowIndex = -1;
        if (this.configListData && this.configListData.records) {
            for (let lIndex = 0; lIndex < this.configListData.records.length; lIndex++) {
                if (this.listConfig.lists[lIndex].identifier == sourceIdentifier) {
                    if (CollectionUtils.isEmpty(data)) {
                        this.configListData.records[lIndex].rows.push({});
                    }
                    else {
                        this.configListData.records[lIndex].rows.push(data);
                    }
                    rows = this.configListData.records[lIndex].rows;
                    rowIndex = this.configListData.records[lIndex].rows.length - 1;
                    break;
                }
            }
        }
        return { rows: rows, rowIndex: rowIndex };
    }
    afterChangeMerge() {
        this.configListData = JSON.parse(JSON.stringify(this.configListData));
        this.listReset = true;
    }
    beforeChildChangeMerge(action, sourceIdentifier) {
        let rows;
        let rowIndex = -1;
        if (this.configListData && this.configListData.records) {
            for (let lIndex = 0; lIndex < this.configListData.records.length; lIndex++) {
                if (this.listConfig.lists[lIndex].identifier == sourceIdentifier) {
                    for (let rIndex = 0; rIndex < this.configListData.records[lIndex].rows.length; rIndex++) {
                        let keys = this.getRowKey(lIndex);
                        let isMatchingRow = true;
                        for (let key of keys) {
                            if (action.parentHierarchy.parent['key'].indexOf(this.configListData.records[lIndex].rows[rIndex][key]) < -1) {
                                isMatchingRow = false;
                            }
                        }
                        if (isMatchingRow) {
                            let childRecordIdentifier = this.getChildRecordIdentifier(lIndex);
                            for (let cIndex = 0; cIndex < this.configListData.records[lIndex].rows[rIndex][childRecordIdentifier].length; cIndex++) {
                                let keys = this.getChildRowKey(lIndex);
                                let isChildMatchingRow = true;
                                for (let key of keys) {
                                    if (this.configListData.records[lIndex].rows[rIndex][childRecordIdentifier][cIndex][key] != action.originalData[key]) {
                                        isChildMatchingRow = false;
                                    }
                                }
                                if (isChildMatchingRow) {
                                    this.configListData.records[lIndex].rows[rIndex][childRecordIdentifier][cIndex] = Object.assign(Object.assign({}, action.originalData), action.data);
                                    rows = this.configListData.records[lIndex].rows[rIndex][childRecordIdentifier];
                                    rowIndex = cIndex;
                                    break;
                                }
                            }
                        }
                    }
                }
            }
        }
        return { rows: rows, rowIndex: rowIndex };
    }
    addChildRow(action, sourceIdentifier, data) {
        let rows;
        let rowIndex = -1;
        if (this.configListData && this.configListData.records) {
            for (let lIndex = 0; lIndex < this.configListData.records.length; lIndex++) {
                if (this.listConfig.lists[lIndex].identifier == action.sourceIdentifier) {
                    for (let rIndex = 0; rIndex < this.configListData.records[lIndex].rows.length; rIndex++) {
                        let keys = this.getRowKey(lIndex);
                        let isMatchingRow = true;
                        for (let key of keys) {
                            if (action.originalData[key].indexOf(this.configListData.records[lIndex].rows[rIndex][key]) < -1) {
                                isMatchingRow = false;
                            }
                        }
                        if (isMatchingRow) {
                            let childRecordIdentifier = this.getChildRecordIdentifier(lIndex);
                            for (let cIndex = 0; cIndex < this.configListData.records[lIndex].rows[rIndex][childRecordIdentifier].length; cIndex++) {
                                if (CollectionUtils.isEmpty(data)) {
                                    this.configListData.records[lIndex].rows[rIndex][childRecordIdentifier].push({});
                                }
                                else {
                                    this.configListData.records[lIndex].rows[rIndex][childRecordIdentifier].push(data);
                                }
                                rows = this.configListData.records[lIndex].rows[rIndex][childRecordIdentifier];
                                rowIndex = cIndex;
                                break;
                            }
                        }
                    }
                }
            }
        }
        return { rows: rows, rowIndex: rowIndex };
    }
    setTabDisplayMode(crudTabs, formDisplayMode) {
        CrudUtils.setDisplayType(crudTabs, formDisplayMode);
    }
    afterChildChangeMerge() {
        this.afterChangeMerge();
    }
    setHeaderTitle(title) {
        this.header.title = title;
    }
    setHeaderDescription(description) {
        this.header.description.text = description;
    }
}
CrudListComponentInterface.decorators = [
    { type: Component, args: [{
                selector: 'mx-crud-list-interface',
                template: "<p>crud-list works!</p>\n",
                styles: [""]
            },] }
];
CrudListComponentInterface.ctorParameters = () => [];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3J1ZC1saXN0LWludGVyZmFjZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiL1VzZXJzL25pdGlua2hhaXRhbi9OaXRpbi9zdHVkeS9hbmd1bGFyL21hdGVyaWFsL2FkbWluLWJ1aWxkZXItcGx1Z2luL3Byb2plY3RzL25neC1tYXRlcmlhbC13aWRnZXQvc3JjLyIsInNvdXJjZXMiOlsibGliL2NydWQvaW50ZXJmYWNlL2NydWQtbGlzdC9jcnVkLWxpc3QtaW50ZXJmYWNlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFVLE1BQU0sZUFBZSxDQUFDO0FBS2xELE9BQU8sRUFBRSxlQUFlLEVBQUUsYUFBYSxFQUFFLFNBQVMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRzdFLGlDQUFpQztBQU1qQyxNQUFNLE9BQU8sMEJBQTBCO0lBc0JyQztRQWRBLFdBQU0sR0FBa0IsSUFBSSxLQUFLLEVBQVUsQ0FBQztRQWUxQyxXQUFXO0lBQ2IsQ0FBQztJQUVELFFBQVE7UUFDTixJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxlQUFlO0lBRWYsQ0FBQztJQUNELGFBQWE7SUFFYixDQUFDO0lBQ0QsU0FBUztRQUNQLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELHdCQUF3QixDQUFDLElBQVU7UUFDakMsVUFBVTtRQUNWLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQTtRQUNqQyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFFMUIseUJBQXlCO1FBQ3pCLG1CQUFtQjtRQUNuQixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztJQUN4QixDQUFDO0lBRUQsc0JBQXNCLENBQUMsSUFBVTtRQUMvQixVQUFVO1FBQ1YsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENB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QyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMscUJBQXFCLENBQUMsQ0FBQztnQ0FDL0UsUUFBUSxHQUFHLE1BQU0sQ0FBQztnQ0FDbEIsTUFBTTs2QkFDUDt5QkFDRjtxQkFDRjtpQkFDRjthQUNGO1NBQ0Y7UUFFRCxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLENBQUM7SUFDNUMsQ0FBQztJQUVELGlCQUFpQixDQUFDLFFBQXdCLEVBQUUsZUFBK0I7UUFDekUsU0FBUyxDQUFDLGNBQWMsQ0FBQyxRQUFRLEVBQUUsZUFBZSxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVELHFCQUFxQjtRQUNuQixJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztJQUMxQixDQUFDO0lBRUQsY0FBYyxDQUFDLEtBQWE7UUFDMUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO0lBQzVCLENBQUM7SUFFRCxvQkFBb0IsQ0FBQyxXQUFtQjtRQUN0QyxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEdBQUcsV0FBVyxDQUFDO0lBQzdDLENBQUM7OztZQTdSRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLHdCQUF3QjtnQkFDbEMscUNBQXlDOzthQUUxQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDcnVkSGVhZGVyLCBBY3Rpb25QYWdlLCBDcnVkTGlzdCwgQ3J1ZExpc3REYXRhLCBDcnVkLCBDcnVkU2VhcmNoLCBDcnVkVGFiIH0gZnJvbSAnLi4vLi4vbW9kZWwnO1xuaW1wb3J0IHsgQnV0dG9uLCBCYWRnZSwgQWN0aW9uIH0gZnJvbSAnLi4vLi4vLi4vYnV0dG9uL21vZGVsJztcbmltcG9ydCB7IEtleU1hcCB9IGZyb20gJy4uLy4uLy4uL2ZpZWxkL21vZGVsJztcbmltcG9ydCB7IExpc3QgfSBmcm9tICcuLi8uLi8uLi9saXN0L21vZGVsJztcbmltcG9ydCB7IENvbGxlY3Rpb25VdGlscywgU2VjdXJpdHlVdGlscywgQ3J1ZFV0aWxzIH0gZnJvbSAnLi4vLi4vLi4vdXRpbGl0eSc7XG5pbXBvcnQgeyBGb3JtRGlhcGx5TW9kZSB9IGZyb20gJy4uLy4uLy4uL2Zvcm0vbW9kZWwnO1xuXG4vL2V4dGVuZHMgTW9kYWxJbnRlcmZhY2VDb21wb25lbnRcbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ214LWNydWQtbGlzdC1pbnRlcmZhY2UnLFxuICB0ZW1wbGF0ZVVybDogJy4vY3J1ZC1saXN0LmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vY3J1ZC1saXN0LmNvbXBvbmVudC5zY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgQ3J1ZExpc3RDb21wb25lbnRJbnRlcmZhY2UgIGltcGxlbWVudHMgT25Jbml0IHtcbiAgLy8gIENvbW1vbiBDb25maWcgXG4gIGlkZW50aWZpZXI6IHN0cmluZztcbiAgaGVhZGVyOiBDcnVkSGVhZGVyO1xuICBhY3Rpb25zOiBBcnJheTxCdXR0b24+O1xuICBhY3Rpb25QYWdlczogQXJyYXk8QWN0aW9uUGFnZT47XG4gIGZvcm1SZXNldDogYm9vbGVhbjtcbiAgbGlzdFJlc2V0OiBib29sZWFuO1xuICBrZXlNYXA6IEFycmF5PEtleU1hcD4gPSBuZXcgQXJyYXk8S2V5TWFwPigpO1xuXG4gIC8vICBMaXN0IENvbmZpZ1xuICBxdWlja0xpbmtzOiBBcnJheTxCdXR0b24+O1xuICBzZWFyY2hDb25maWc6IENydWRTZWFyY2g7XG4gIHNlYXJjaERhdGE6IGFueTtcbiAgbGlzdENvbmZpZzogQ3J1ZExpc3Q7XG4gIGxpc3RQYWdlQmFja1JvdXRlOiBBcnJheTxzdHJpbmc+O1xuXG4gIGV4cGFuZFJvd0luZGV4OiBudW1iZXI7XG4gIFxuICBjb25maWdMaXN0RGF0YTogQ3J1ZExpc3REYXRhOyBcbiAgb3JpZ2luYWxEYXRhOiBhbnk7XG5cbiAgY29uc3RydWN0b3IoKSB7IFxuICAgIC8vIHN1cGVyKCk7XG4gIH1cblxuICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLnNldENvbW1vbkNvbmZpZygpO1xuICAgIHRoaXMuc2V0TGlzdENvbmZpZygpO1xuICB9XG5cbiAgc2V0Q29tbW9uQ29uZmlnKCk6IHZvaWQge1xuXG4gIH1cbiAgc2V0TGlzdENvbmZpZygpOiB2b2lke1xuXG4gIH1cbiAgc2V0QmFkZ2VzKCk6IEFycmF5PEJhZGdlPntcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHNldENvbW1vbkNvbmZpZ1VzaW5nQ3J1ZChjcnVkOiBDcnVkKTogdm9pZCB7XG4gICAgLy8gIENvbmZpZ1xuICAgIHRoaXMuaWRlbnRpZmllciA9IGNydWQuaWRlbnRpZmllclxuICAgIHRoaXMuaGVhZGVyID0gY3J1ZC5oZWFkZXI7XG4gICAgXG4gICAgLy8gIFRhYiB3aXNlIGRhdGEvc2V0dGluZ1xuICAgIC8vdGhpcy5rZXlNYXAgPSB7fTtcbiAgICB0aGlzLmxpc3RSZXNldCA9IHRydWU7XG4gIH1cblxuICBzZXRMaXN0Q29uZmlnVXNpbmdDcnVkKGNydWQ6IENydWQpOiB2b2lkIHtcbiAgICAvLyAgQ29uZmlnXG4gICAgdGhpcy5xdWlja0xpbmtzID0gY3J1ZC5xdWlja0xpbmtzO1xuICAgIHRoaXMuc2VhcmNoQ29uZmlnID0gY3J1ZC5zZWFyY2g7XG4gICAgdGhpcy5saXN0Q29uZmlnID0gY3J1ZC5saXN0O1xuICAgIHRoaXMuYWN0aW9ucyA9IGNydWQuYWN0aW9ucztcblxuICAgIHRoaXMuc2V0Q29uZmlnTGlzdERhdGEoW10sIFtdKTtcbiAgfVxuIFxuICBsb2FkRmlsdGVyUGFyYW1zKGZpbHRlclN0cjogc3RyaW5nKSB7XG4gICAgaWYgKGZpbHRlclN0ciAhPSBudWxsKSB7XG4gICAgICBjb25zdCBmaWx0ZXIgPSBTZWN1cml0eVV0aWxzLmRlY3J5cHQoZmlsdGVyU3RyKTtcblxuICAgICAgdGhpcy5jb25maWdMaXN0RGF0YS5zZWFyY2hEYXRhID0gZmlsdGVyO1xuICAgIH0gZWxzZSB7XG4gICAgfVxuICAgIHRoaXMuY29uZmlnTGlzdERhdGEucGFnZU5vID0gMTtcbiAgfVxuICBcbiAgc2V0Q29uZmlnTGlzdERhdGEocmVjb3JkczogQXJyYXk8YW55PiwgYmFkZ2VzOiBBcnJheTxCYWRnZT4sIHJvdXRlPzogQXJyYXk8c3RyaW5nPik6IHZvaWQge1xuICAgIGxldCBjb25maWdMaXN0RGF0YU5ldyA9IHtcbiAgICAgIHBhZ2VCYWNrUm91dGU6IHJvdXRlLCBcbiAgICAgIGJhZGdlczogYmFkZ2VzLFxuICAgICAgcmVjb3JkczogcmVjb3JkcyxcbiAgICAgIG9yaWdpbmFsRGF0YTogdGhpcy5vcmlnaW5hbERhdGFcbiAgICB9XG5cbiAgICB0aGlzLmNvbmZpZ0xpc3REYXRhID0geyAuLi50aGlzLmNvbmZpZ0xpc3REYXRhLCAuLi5jb25maWdMaXN0RGF0YU5ldyB9OyAgICBcbiAgfVxuXG4gIGdldFJvd0tleShsSW5kZXg6IG51bWJlcik6IEFycmF5PHN0cmluZz4ge1xuICAgIGxldCBrZXlzOiBBcnJheTxzdHJpbmc+O1xuXG4gICAgaWYgKHRoaXMubGlzdENvbmZpZyAmJiB0aGlzLmxpc3RDb25maWcubGlzdHMgJiYgdGhpcy5saXN0Q29uZmlnLmxpc3RzW2xJbmRleF0pIHtcbiAgICAgIGtleXMgPSB0aGlzLmxpc3RDb25maWcubGlzdHNbbEluZGV4XS51bmlxdWVLZXlzO1xuICAgIH0gZWxzZSB7XG4gICAgICBrZXlzID0gbmV3IEFycmF5PHN0cmluZz4oKTtcbiAgICB9XG5cbiAgICByZXR1cm4ga2V5cztcbiAgfVxuXG4gIGdldENoaWxkUm93S2V5KGxJbmRleDogbnVtYmVyKTogQXJyYXk8c3RyaW5nPiB7XG4gICAgbGV0IGtleXM6IEFycmF5PHN0cmluZz47XG5cbiAgICBpZiAodGhpcy5saXN0Q29uZmlnICYmIHRoaXMubGlzdENvbmZpZy5saXN0cyAmJiB0aGlzLmxpc3RDb25maWcubGlzdHNbbEluZGV4XSAmJiB0aGlzLmxpc3RDb25maWcubGlzdHNbbEluZGV4XS5jaGlsZCAmJiB0aGlzLmxpc3RDb25maWcubGlzdHNbbEluZGV4XS5jaGlsZC5yZWNvcmQgJiYgKDxMaXN0PnRoaXMubGlzdENvbmZpZy5saXN0c1tsSW5kZXhdLmNoaWxkLnJlY29yZCkudW5pcXVlS2V5cykge1xuICAgICAga2V5cyA9ICg8TGlzdD50aGlzLmxpc3RDb25maWcubGlzdHNbbEluZGV4XS5jaGlsZC5yZWNvcmQpLnVuaXF1ZUtleXM7XG4gICAgfSBlbHNlIHtcbiAgICAgIGtleXMgPSBuZXcgQXJyYXk8c3RyaW5nPigpO1xuICAgIH1cblxuICAgIHJldHVybiBrZXlzO1xuICB9XG5cbiAgZ2V0Q2hpbGRSZWNvcmRJZGVudGlmaWVyKGxJbmRleDogbnVtYmVyKTogc3RyaW5nIHtcbiAgICBsZXQgY2hpbGRSZWNvcmRJZGVudGlmaWVyOiBzdHJpbmc7XG5cbiAgICBpZiAodGhpcy5saXN0Q29uZmlnICYmIHRoaXMubGlzdENvbmZpZy5saXN0cyAmJiB0aGlzLmxpc3RDb25maWcubGlzdHNbbEluZGV4XSAmJiB0aGlzLmxpc3RDb25maWcubGlzdHNbbEluZGV4XS5jaGlsZCkge1xuICAgICAgY2hpbGRSZWNvcmRJZGVudGlmaWVyID0gdGhpcy5saXN0Q29uZmlnLmxpc3RzW2xJbmRleF0uY2hpbGQucmVjb3JkSWRlbnRpZmllcjtcbiAgICB9IGVsc2Uge1xuICAgICAgY2hpbGRSZWNvcmRJZGVudGlmaWVyID0gXCJcIjtcbiAgICB9XG5cbiAgICByZXR1cm4gY2hpbGRSZWNvcmRJZGVudGlmaWVyO1xuICB9XG5cbiAgYmVmb3JlQ2hhbmdlTWVyZ2UoYWN0aW9uOiBBY3Rpb24sIHNvdXJjZUlkZW50aWZpZXI6IHN0cmluZyk6IHsgcm93czogQXJyYXk8YW55Piwgcm93SW5kZXg6IG51bWJlciB9IHtcbiAgICBsZXQgcm93czogQXJyYXk8YW55PjtcbiAgICBsZXQgcm93SW5kZXg6IG51bWJlciA9IC0xO1xuXG4gICAgaWYgKHRoaXMuY29uZmlnTGlzdERhdGEgJiYgdGhpcy5jb25maWdMaXN0RGF0YS5yZWNvcmRzKSB7XG4gICAgICBmb3IgKGxldCBsSW5kZXggPSAwOyBsSW5kZXggPCB0aGlzLmNvbmZpZ0xpc3REYXRhLnJlY29yZHMubGVuZ3RoOyBsSW5kZXgrKykge1xuICAgICAgICBpZiAodGhpcy5saXN0Q29uZmlnLmxpc3RzW2xJbmRleF0uaWRlbnRpZmllciA9PSBzb3VyY2VJZGVudGlmaWVyKSB7XG4gICAgICAgICAgZm9yIChsZXQgckluZGV4ID0gMDsgckluZGV4IDwgdGhpcy5jb25maWdMaXN0RGF0YS5yZWNvcmRzW2xJbmRleF0ucm93cy5sZW5ndGg7IHJJbmRleCsrKSB7XG4gICAgICAgICAgICBsZXQga2V5cyA9IHRoaXMuZ2V0Um93S2V5KGxJbmRleCk7XG5cbiAgICAgICAgICAgIGxldCBpc01hdGNoaW5nUm93ID0gdHJ1ZTtcbiAgICAgICAgICAgIGZvciAobGV0IGtleSBvZiBrZXlzKSB7XG4gICAgICAgICAgICAgIGlmICh0aGlzLmNvbmZpZ0xpc3REYXRhLnJlY29yZHNbbEluZGV4XS5yb3dzW3JJbmRleF1ba2V5XSAhPSBhY3Rpb24ub3JpZ2luYWxEYXRhW2tleV0pIHtcbiAgICAgICAgICAgICAgICBpc01hdGNoaW5nUm93ID0gZmFsc2U7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGlzTWF0Y2hpbmdSb3cpIHtcbiAgICAgICAgICAgICAgdGhpcy5jb25maWdMaXN0RGF0YS5yZWNvcmRzW2xJbmRleF0ucm93c1tySW5kZXhdID0geyAuLi5hY3Rpb24ub3JpZ2luYWxEYXRhLCAuLi5hY3Rpb24uZGF0YSB9O1xuXG4gICAgICAgICAgICAgIHJvd3MgPSB0aGlzLmNvbmZpZ0xpc3REYXRhLnJlY29yZHNbbEluZGV4XS5yb3dzO1xuICAgICAgICAgICAgICByb3dJbmRleCA9IHJJbmRleDtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgcm93czogcm93cywgcm93SW5kZXg6IHJvd0luZGV4IH07XG4gIH1cblxuICBhZGRSb3coYWN0aW9uOiBBY3Rpb24sIHNvdXJjZUlkZW50aWZpZXI6IHN0cmluZywgZGF0YT86IGFueSk6IHsgcm93czogQXJyYXk8YW55Piwgcm93SW5kZXg6IG51bWJlciB9IHtcbiAgICBsZXQgcm93czogQXJyYXk8YW55PjtcbiAgICBsZXQgcm93SW5kZXg6IG51bWJlciA9IC0xOyBcblxuICAgIGlmICh0aGlzLmNvbmZpZ0xpc3REYXRhICYmIHRoaXMuY29uZmlnTGlzdERhdGEucmVjb3Jkcykge1xuICAgICAgZm9yIChsZXQgbEluZGV4ID0gMDsgbEluZGV4IDwgdGhpcy5jb25maWdMaXN0RGF0YS5yZWNvcmRzLmxlbmd0aDsgbEluZGV4KyspIHtcbiAgICAgICAgaWYgKHRoaXMubGlzdENvbmZpZy5saXN0c1tsSW5kZXhdLmlkZW50aWZpZXIgPT0gc291cmNlSWRlbnRpZmllcikge1xuICAgICAgICAgIGlmIChDb2xsZWN0aW9uVXRpbHMuaXNFbXB0eShkYXRhKSkgIHtcbiAgICAgICAgICAgIHRoaXMuY29uZmlnTGlzdERhdGEucmVjb3Jkc1tsSW5kZXhdLnJvd3MucHVzaCh7fSk7XG4gICAgICAgICAgfSBlbHNlICB7XG4gICAgICAgICAgICB0aGlzLmNvbmZpZ0xpc3REYXRhLnJlY29yZHNbbEluZGV4XS5yb3dzLnB1c2goZGF0YSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcm93cyA9IHRoaXMuY29uZmlnTGlzdERhdGEucmVjb3Jkc1tsSW5kZXhdLnJvd3M7XG4gICAgICAgICAgcm93SW5kZXggPSB0aGlzLmNvbmZpZ0xpc3REYXRhLnJlY29yZHNbbEluZGV4XS5yb3dzLmxlbmd0aCAtIDE7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4geyByb3dzOiByb3dzLCByb3dJbmRleDogcm93SW5kZXggfTtcbiAgfVxuXG4gIGFmdGVyQ2hhbmdlTWVyZ2UoKSB7XG4gICAgdGhpcy5jb25maWdMaXN0RGF0YSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGhpcy5jb25maWdMaXN0RGF0YSkpO1xuICAgIHRoaXMubGlzdFJlc2V0ID0gdHJ1ZTtcbiAgfVxuXG5cbiAgYmVmb3JlQ2hpbGRDaGFuZ2VNZXJnZShhY3Rpb246IEFjdGlvbiwgc291cmNlSWRlbnRpZmllcjogc3RyaW5nKTogeyByb3dzOiBBcnJheTxhbnk+LCByb3dJbmRleDogbnVtYmVyIH0ge1xuICAgIGxldCByb3dzOiBBcnJheTxhbnk+O1xuICAgIGxldCByb3dJbmRleDogbnVtYmVyID0gLTE7XG5cbiAgICBpZiAodGhpcy5jb25maWdMaXN0RGF0YSAmJiB0aGlzLmNvbmZpZ0xpc3REYXRhLnJlY29yZHMpIHtcbiAgICAgIGZvciAobGV0IGxJbmRleCA9IDA7IGxJbmRleCA8IHRoaXMuY29uZmlnTGlzdERhdGEucmVjb3Jkcy5sZW5ndGg7IGxJbmRleCsrKSB7XG4gICAgICAgIGlmICh0aGlzLmxpc3RDb25maWcubGlzdHNbbEluZGV4XS5pZGVudGlmaWVyID09IHNvdXJjZUlkZW50aWZpZXIpIHtcbiAgICAgICAgICBmb3IgKGxldCBySW5kZXggPSAwOyBySW5kZXggPCB0aGlzLmNvbmZpZ0xpc3REYXRhLnJlY29yZHNbbEluZGV4XS5yb3dzLmxlbmd0aDsgckluZGV4KyspIHtcbiAgICAgICAgICAgIGxldCBrZXlzID0gdGhpcy5nZXRSb3dLZXkobEluZGV4KTtcblxuICAgICAgICAgICAgbGV0IGlzTWF0Y2hpbmdSb3cgPSB0cnVlO1xuICAgICAgICAgICAgZm9yIChsZXQga2V5IG9mIGtleXMpIHtcbiAgICAgICAgICAgICAgaWYgKCg8QXJyYXk8c3RyaW5nPj5hY3Rpb24ucGFyZW50SGllcmFyY2h5LnBhcmVudFsna2V5J10pLmluZGV4T2YodGhpcy5jb25maWdMaXN0RGF0YS5yZWNvcmRzW2xJbmRleF0ucm93c1tySW5kZXhdW2tleV0pIDwgLTEpIHtcbiAgICAgICAgICAgICAgICBpc01hdGNoaW5nUm93ID0gZmFsc2U7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGlzTWF0Y2hpbmdSb3cpIHtcbiAgICAgICAgICAgICAgbGV0IGNoaWxkUmVjb3JkSWRlbnRpZmllciA9IHRoaXMuZ2V0Q2hpbGRSZWNvcmRJZGVudGlmaWVyKGxJbmRleCk7XG5cbiAgICAgICAgICAgICAgZm9yIChsZXQgY0luZGV4ID0gMDsgY0luZGV4IDwgdGhpcy5jb25maWdMaXN0RGF0YS5yZWNvcmRzW2xJbmRleF0ucm93c1tySW5kZXhdW2NoaWxkUmVjb3JkSWRlbnRpZmllcl0ubGVuZ3RoOyBjSW5kZXgrKykge1xuICAgICAgICAgICAgICAgIGxldCBrZXlzID0gdGhpcy5nZXRDaGlsZFJvd0tleShsSW5kZXgpO1xuXG4gICAgICAgICAgICAgICAgbGV0IGlzQ2hpbGRNYXRjaGluZ1JvdyA9IHRydWU7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQga2V5IG9mIGtleXMpIHtcbiAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNvbmZpZ0xpc3REYXRhLnJlY29yZHNbbEluZGV4XS5yb3dzW3JJbmRleF1bY2hpbGRSZWNvcmRJZGVudGlmaWVyXVtjSW5kZXhdW2tleV0gIT0gYWN0aW9uLm9yaWdpbmFsRGF0YVtrZXldKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzQ2hpbGRNYXRjaGluZ1JvdyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChpc0NoaWxkTWF0Y2hpbmdSb3cpIHtcbiAgICAgICAgICAgICAgICAgIHRoaXMuY29uZmlnTGlzdERhdGEucmVjb3Jkc1tsSW5kZXhdLnJvd3NbckluZGV4XVtjaGlsZFJlY29yZElkZW50aWZpZXJdW2NJbmRleF0gPSB7IC4uLmFjdGlvbi5vcmlnaW5hbERhdGEsIC4uLmFjdGlvbi5kYXRhIH07XG5cbiAgICAgICAgICAgICAgICAgIHJvd3MgPSB0aGlzLmNvbmZpZ0xpc3REYXRhLnJlY29yZHNbbEluZGV4XS5yb3dzW3JJbmRleF1bY2hpbGRSZWNvcmRJZGVudGlmaWVyXTtcbiAgICAgICAgICAgICAgICAgIHJvd0luZGV4ID0gY0luZGV4O1xuICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgcm93czogcm93cywgcm93SW5kZXg6IHJvd0luZGV4IH07XG4gIH1cblxuICBhZGRDaGlsZFJvdyhhY3Rpb246IEFjdGlvbiwgc291cmNlSWRlbnRpZmllcjogc3RyaW5nLCBkYXRhPzogYW55KTogeyByb3dzOiBBcnJheTxhbnk+LCByb3dJbmRleDogbnVtYmVyIH0ge1xuICAgIGxldCByb3dzOiBBcnJheTxhbnk+O1xuICAgIGxldCByb3dJbmRleDogbnVtYmVyID0gLTE7XG5cbiAgICBpZiAodGhpcy5jb25maWdMaXN0RGF0YSAmJiB0aGlzLmNvbmZpZ0xpc3REYXRhLnJlY29yZHMpIHtcbiAgICAgIGZvciAobGV0IGxJbmRleCA9IDA7IGxJbmRleCA8IHRoaXMuY29uZmlnTGlzdERhdGEucmVjb3Jkcy5sZW5ndGg7IGxJbmRleCsrKSB7XG4gICAgICAgIGlmICh0aGlzLmxpc3RDb25maWcubGlzdHNbbEluZGV4XS5pZGVudGlmaWVyID09IGFjdGlvbi5zb3VyY2VJZGVudGlmaWVyKSB7XG4gICAgICAgICAgZm9yIChsZXQgckluZGV4ID0gMDsgckluZGV4IDwgdGhpcy5jb25maWdMaXN0RGF0YS5yZWNvcmRzW2xJbmRleF0ucm93cy5sZW5ndGg7IHJJbmRleCsrKSB7XG4gICAgICAgICAgICBsZXQga2V5cyA9IHRoaXMuZ2V0Um93S2V5KGxJbmRleCk7XG5cbiAgICAgICAgICAgIGxldCBpc01hdGNoaW5nUm93ID0gdHJ1ZTtcbiAgICAgICAgICAgIGZvciAobGV0IGtleSBvZiBrZXlzKSB7XG4gICAgICAgICAgICAgIGlmICgoPEFycmF5PHN0cmluZz4+YWN0aW9uLm9yaWdpbmFsRGF0YVtrZXldKS5pbmRleE9mKHRoaXMuY29uZmlnTGlzdERhdGEucmVjb3Jkc1tsSW5kZXhdLnJvd3NbckluZGV4XVtrZXldKSA8IC0xKSB7XG4gICAgICAgICAgICAgICAgaXNNYXRjaGluZ1JvdyA9IGZhbHNlO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChpc01hdGNoaW5nUm93KSB7XG4gICAgICAgICAgICAgIGxldCBjaGlsZFJlY29yZElkZW50aWZpZXIgPSB0aGlzLmdldENoaWxkUmVjb3JkSWRlbnRpZmllcihsSW5kZXgpO1xuXG4gICAgICAgICAgICAgIGZvciAobGV0IGNJbmRleCA9IDA7IGNJbmRleCA8IHRoaXMuY29uZmlnTGlzdERhdGEucmVjb3Jkc1tsSW5kZXhdLnJvd3NbckluZGV4XVtjaGlsZFJlY29yZElkZW50aWZpZXJdLmxlbmd0aDsgY0luZGV4KyspIHtcbiAgICAgICAgICAgICAgICBpZiAoQ29sbGVjdGlvblV0aWxzLmlzRW1wdHkoZGF0YSkpICB7XG4gICAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZ0xpc3REYXRhLnJlY29yZHNbbEluZGV4XS5yb3dzW3JJbmRleF1bY2hpbGRSZWNvcmRJZGVudGlmaWVyXS5wdXNoKHt9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgIHtcbiAgICAgICAgICAgICAgICAgIHRoaXMuY29uZmlnTGlzdERhdGEucmVjb3Jkc1tsSW5kZXhdLnJvd3NbckluZGV4XVtjaGlsZFJlY29yZElkZW50aWZpZXJdLnB1c2goZGF0YSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcm93cyA9IHRoaXMuY29uZmlnTGlzdERhdGEucmVjb3Jkc1tsSW5kZXhdLnJvd3NbckluZGV4XVtjaGlsZFJlY29yZElkZW50aWZpZXJdO1xuICAgICAgICAgICAgICAgIHJvd0luZGV4ID0gY0luZGV4O1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB7IHJvd3M6IHJvd3MsIHJvd0luZGV4OiByb3dJbmRleCB9O1xuICB9XG5cbiAgc2V0VGFiRGlzcGxheU1vZGUoY3J1ZFRhYnM6IEFycmF5PENydWRUYWI+LCBmb3JtRGlzcGxheU1vZGU6IEZvcm1EaWFwbHlNb2RlKSB7XG4gICAgQ3J1ZFV0aWxzLnNldERpc3BsYXlUeXBlKGNydWRUYWJzLCBmb3JtRGlzcGxheU1vZGUpO1xuICB9XG5cbiAgYWZ0ZXJDaGlsZENoYW5nZU1lcmdlKCkge1xuICAgIHRoaXMuYWZ0ZXJDaGFuZ2VNZXJnZSgpO1xuICB9XG5cbiAgc2V0SGVhZGVyVGl0bGUodGl0bGU6IHN0cmluZykgIHtcbiAgICB0aGlzLmhlYWRlci50aXRsZSA9IHRpdGxlO1xuICB9XG5cbiAgc2V0SGVhZGVyRGVzY3JpcHRpb24oZGVzY3JpcHRpb246IHN0cmluZykgIHtcbiAgICB0aGlzLmhlYWRlci5kZXNjcmlwdGlvbi50ZXh0ID0gZGVzY3JpcHRpb247XG4gIH1cbn1cbiJdfQ==