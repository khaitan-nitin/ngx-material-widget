import { CollectionUtils } from './collection.utility';
import { FormUtils } from './form.utility';
import { FieldUtils } from './field.utility';
import { StringUtils } from './string.utility';
export class ListUtils {
    static addColoumn() {
    }
    static hideColoumn() {
    }
    static setOptionsUsingKey(list, fieldKey, masterDataKey) {
        if (!CollectionUtils.isEmpty(list) && !CollectionUtils.isEmpty(list.columns)) {
            list.columns.forEach(column => {
                if (!CollectionUtils.isEmpty(column) && !CollectionUtils.isEmpty(column.fields)) {
                    column.fields.forEach(field => {
                        if (!CollectionUtils.isEmpty(field) && field.key == fieldKey && (field.type == "AUTOCOMPLETE" /* AUTOCOMPLETE */ || field.type == "CHECKBOX" /* CHECKBOX */ || field.type == "RADIO" /* RADIO */ || field.type == "DROPDOWN" /* DROPDOWN */)) {
                            FieldUtils.setOptionsUsingKey(field, masterDataKey);
                        }
                    });
                }
            });
        }
    }
    static setOptionsUsingValues(list, fieldKey, keyMap, relaodAll, record) {
        if (!CollectionUtils.isEmpty(list) && !CollectionUtils.isEmpty(list.columns)) {
            list.columns.forEach(column => {
                if (!CollectionUtils.isEmpty(column) && !CollectionUtils.isEmpty(column.fields)) {
                    column.fields.forEach(field => {
                        let isMatchingDependendKeyMap = false;
                        if (!StringUtils.isEmpty(field.optionDependsOn)) {
                            //  get optionDependsOn field value
                            let optionDependsOnValue = FormUtils.getValueViaEval(record, field.optionDependsOn);
                            if (keyMap.optionDependsOnValue == optionDependsOnValue) {
                                isMatchingDependendKeyMap = true;
                            }
                        }
                        else {
                            isMatchingDependendKeyMap = true;
                        }
                        if (!CollectionUtils.isEmpty(field) && field.key == fieldKey && (field.type == "AUTOCOMPLETE" /* AUTOCOMPLETE */ || field.type == "CHECKBOX" /* CHECKBOX */ || field.type == "RADIO" /* RADIO */ || field.type == "DROPDOWN" /* DROPDOWN */)) {
                            if (isMatchingDependendKeyMap) { //} || relaodAll)   {
                                FieldUtils.setOptionsUsingValues(field, keyMap);
                            }
                        }
                    });
                }
            });
        }
    }
    static getColumnKey(column) {
        let key;
        if (column.key) {
            key = column.key;
        }
        else {
            if (column.fields && column.fields.length > 0) {
                key = column.fields[0].key;
            }
        }
        return key;
    }
    static getColumnLabel(column) {
        let label;
        if (column.label) {
            label = column.label;
        }
        else {
            if (column.fields && column.fields.length > 0) {
                label = column.fields[0].label;
            }
        }
        return label;
    }
    static getColumnSelectorField(listConfig) {
        let options = new Array();
        let values = new Array();
        for (let column of listConfig.columns) {
            let key = this.getColumnKey(column);
            let label = this.getColumnLabel(column);
            options.push({
                key: key,
                value: label,
                disabled: false,
                selected: column.show
            });
            if (column.show) {
                values.push(key);
            }
        }
        let columnSelectorField = {
            key: "columnSelector",
            label: "Display Column",
            type: "DROPDOWN" /* DROPDOWN */,
            appearance: "STANDARD" /* STANDARD */,
            isReadOnly: false,
            fieldDisplayType: "INLINE" /* INLINE */,
            placeholder: "Columns to display",
            options: options,
            multiselect: true,
            value: values
        };
        return columnSelectorField;
    }
    static getMobileConfig(listConfig) {
        if (!CollectionUtils.isEmpty(listConfig) && !CollectionUtils.isEmpty(listConfig.mobile) && !CollectionUtils.isEmpty(listConfig.mobile.cells)) {
            this.setCustomLayout(listConfig, listConfig.mobile);
        }
    }
    static setCustomLayouts(listConfig) {
        if (this.hasRowHover(listConfig)) {
            this.setCustomLayout(listConfig, listConfig.row.hover.template.layout);
        }
        if (this.hasCustomCellLayout(listConfig)) {
            listConfig.columns.forEach(column => {
                if (column.template && column.template.layout) {
                    this.setCustomLayout(listConfig, column.template.layout);
                }
            });
        }
        if (this.hasCustomRowLayout(listConfig)) {
            this.setCustomLayout(listConfig, listConfig.row.template.layout);
        }
    }
    static hasRowHover(listConfig) {
        let hasHoverConfig = false;
        if (listConfig && listConfig.row && listConfig.row.hover && listConfig.row.hover.template && listConfig.row.hover.template.layout) {
            hasHoverConfig = true;
        }
        return hasHoverConfig;
    }
    static hasCustomRowLayout(listConfig) {
        let hasCustomRowLayout = false;
        if (listConfig && listConfig.row && listConfig.row.template && listConfig.row.template.layout) {
            hasCustomRowLayout = true;
        }
        return hasCustomRowLayout;
    }
    static hasCustomCellLayout(listConfig) {
        let hasCustomCellLayout = false;
        if (listConfig && !CollectionUtils.isEmpty(listConfig.columns)) {
            listConfig.columns.forEach(column => {
                if (column.template && column.template.layout) {
                    hasCustomCellLayout = true;
                }
            });
        }
        return hasCustomCellLayout;
    }
    static setCustomLayout(listConfig, layout) {
        if (layout && !CollectionUtils.isEmpty(layout.cells)) {
            layout.cells.forEach(cell => {
                if (!CollectionUtils.isEmpty(cell.controls)) {
                    cell.controls.forEach(control => {
                        if (CollectionUtils.isEmpty(control.control)) {
                            let resolvedControl = {};
                            resolvedControl = this.getControl(listConfig, control);
                            control.control = resolvedControl.control;
                            control.colIndex = resolvedControl.colIndex;
                            control.cControlIndex = resolvedControl.cControlIndex;
                            // if (control.type == CellControllType.BUTTON && control.control['type'] == ButtonType.CHIP) {
                            //     control.control['groupIdentifier'] = control.control.identifier + cell.rows + cell.cols;
                            // }
                        }
                    });
                }
            });
        }
    }
    static getControl(listConfig, cellControl) {
        let control = {};
        if (cellControl.control) {
            control = { control: cellControl.control, colIndex: 0, cControlIndex: 0 };
        }
        else if (!CollectionUtils.isEmpty(listConfig) && !CollectionUtils.isEmpty(listConfig.columns) && cellControl.type == "FIELD" /* FIELD */) {
            control = this.getColumnControl(listConfig.columns, cellControl.key);
        }
        else if (!CollectionUtils.isEmpty(listConfig) && !CollectionUtils.isEmpty(listConfig.actions) && cellControl.type == "BUTTON" /* BUTTON */) {
            control.control = this.getButtonControl(listConfig.actions, cellControl.key);
            control.colIndex = listConfig.columns.length;
        }
        return control;
    }
    static getColumnControl(columns, controlKey) {
        let control = {};
        let colIndex = 0;
        columns.forEach(column => {
            if (!CollectionUtils.isEmpty(column.fields) && CollectionUtils.isEmpty(control.control)) {
                let cControlIndex = 0;
                column.fields.forEach(field => {
                    if (CollectionUtils.isEmpty(control.control)) {
                        control = ListUtils.getFieldControl(field, controlKey, colIndex, cControlIndex);
                        cControlIndex++;
                    }
                });
            }
            colIndex++;
        });
        return control;
    }
    static getFieldControl(field, controlKey, colIndex, cControlIndex) {
        let control = {};
        if (field.key == controlKey) {
            control.control = field;
            control.colIndex = colIndex;
            control.cControlIndex = cControlIndex;
            console.log("1111111");
            console.log(control);
        }
        return control;
    }
    static getButtonControl(buttons, controlKey) {
        let control;
        buttons.forEach(button => {
            if (button.identifier == controlKey) {
                control = button;
            }
        });
        return control;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdC51dGlsaXR5LmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9uaXRpbmtoYWl0YW4vTml0aW4vc3R1ZHkvYW5ndWxhci9tYXRlcmlhbC9hZG1pbi1idWlsZGVyLXBsdWdpbi9wcm9qZWN0cy9uZ3gtbWF0ZXJpYWwtd2lkZ2V0L3NyYy8iLCJzb3VyY2VzIjpbImxpYi91dGlsaXR5L2xpc3QudXRpbGl0eS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDdkQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM3QyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFJL0MsTUFBTSxPQUFPLFNBQVM7SUFDbEIsTUFBTSxDQUFDLFVBQVU7SUFFakIsQ0FBQztJQUVELE1BQU0sQ0FBQyxXQUFXO0lBRWxCLENBQUM7SUFFRCxNQUFNLENBQUMsa0JBQWtCLENBQUMsSUFBVSxFQUFFLFFBQWdCLEVBQUUsYUFBcUI7UUFDekUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUMxRSxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTtnQkFDMUIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRTtvQkFDN0UsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUU7d0JBQzFCLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLEtBQUssQ0FBQyxH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LGFBQWEsQ0FBQyxDQUFDO3dCQUNoRixhQUFhLEVBQUUsQ0FBQztxQkFDbkI7Z0JBQ0wsQ0FBQyxDQUFDLENBQUE7YUFDTDtZQUNELFFBQVEsRUFBRSxDQUFDO1FBQ2YsQ0FBQyxDQUFDLENBQUE7UUFFRixPQUFPLE9BQU8sQ0FBQztJQUNuQixDQUFDO0lBRUQsTUFBTSxDQUFDLGVBQWUsQ0FBQyxLQUFVLEVBQUUsVUFBa0IsRUFBRSxRQUFnQixFQUFFLGFBQXFCO1FBQzFGLElBQUksT0FBTyxHQUFpRSxFQUFFLENBQUM7UUFFL0UsSUFBSSxLQUFLLENBQUMsR0FBRyxJQUFJLFVBQVUsRUFBRTtZQUN6QixPQUFPLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztZQUN4QixPQUFPLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztZQUM1QixPQUFPLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQztZQUN0QyxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3ZCLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDeEI7UUFFRCxPQUFPLE9BQU8sQ0FBQztJQUNuQixDQUFDO0lBRUQsTUFBTSxDQUFDLGdCQUFnQixDQUFDLE9BQXNCLEVBQUUsVUFBa0I7UUFDOUQsSUFBSSxPQUFZLENBQUM7UUFFakIsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUNyQixJQUFJLE1BQU0sQ0FBQyxVQUFVLElBQUksVUFBVSxFQUFFO2dCQUNqQyxPQUFPLEdBQUcsTUFBTSxDQUFDO2FBQ3BCO1FBQ0wsQ0FBQyxDQUFDLENBQUE7UUFFRixPQUFPLE9BQU8sQ0FBQztJQUNuQixDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDZWxsQ29udHJvbCwgQ2VsbENvbnRyb2xsVHlwZSwgQ29sdW1uLCBMaXN0LCBMaXN0Q3VzdG9tTGF5b3V0IH0gZnJvbSAnLi4vbGlzdC9tb2RlbCc7XG5pbXBvcnQgeyBDb2xsZWN0aW9uVXRpbHMgfSBmcm9tICcuL2NvbGxlY3Rpb24udXRpbGl0eSc7XG5pbXBvcnQgeyBGb3JtVXRpbHMgfSBmcm9tICcuL2Zvcm0udXRpbGl0eSc7XG5pbXBvcnQgeyBGaWVsZFV0aWxzIH0gZnJvbSAnLi9maWVsZC51dGlsaXR5JztcbmltcG9ydCB7IFN0cmluZ1V0aWxzIH0gZnJvbSAnLi9zdHJpbmcudXRpbGl0eSc7XG5pbXBvcnQgeyBGaWVsZFR5cGUsIEF1dG9jb21wbGV0ZUZpZWxkLCBSYWRpb0ZpZWxkLCBDaGVja2JveEZpZWxkLCBEcm9wZG93bkZpZWxkLCBEcm9wZG93bk9wdGlvbiwgS2V5TWFwLCBGaWVsZEFwcGVhcmFuY2UsIEZpZWxkRGlhcGx5VHlwZSB9IGZyb20gJy4uL2ZpZWxkL21vZGVsJztcbmltcG9ydCB7IEJ1dHRvbiwgQnV0dG9uVHlwZSB9IGZyb20gJy4uL2J1dHRvbi9tb2RlbCc7XG5cbmV4cG9ydCBjbGFzcyBMaXN0VXRpbHMge1xuICAgIHN0YXRpYyBhZGRDb2xvdW1uKCkge1xuXG4gICAgfVxuXG4gICAgc3RhdGljIGhpZGVDb2xvdW1uKCkge1xuXG4gICAgfVxuXG4gICAgc3RhdGljIHNldE9wdGlvbnNVc2luZ0tleShsaXN0OiBMaXN0LCBmaWVsZEtleTogc3RyaW5nLCBtYXN0ZXJEYXRhS2V5OiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKCFDb2xsZWN0aW9uVXRpbHMuaXNFbXB0eShsaXN0KSAmJiAhQ29sbGVjdGlvblV0aWxzLmlzRW1wdHkobGlzdC5jb2x1bW5zKSkge1xuICAgICAgICAgICAgbGlzdC5jb2x1bW5zLmZvckVhY2goY29sdW1uID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIUNvbGxlY3Rpb25VdGlscy5pc0VtcHR5KGNvbHVtbikgJiYgIUNvbGxlY3Rpb25VdGlscy5pc0VtcHR5KGNvbHVtbi5maWVsZHMpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbHVtbi5maWVsZHMuZm9yRWFjaChmaWVsZCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIUNvbGxlY3Rpb25VdGlscy5pc0VtcHR5KGZpZWxkKSAmJiBmaWVsZC5rZXkgPT0gZmllbGRLZXkgJiYgKGZpZWxkLnR5cGUgPT0gRmllbGRUeXBlLkFVVE9DT01QTEVURSB8fCBmaWVsZC50eXBlID09IEZpZWxkVHlwZS5DSEVDS0JPWCB8fCBmaWVsZC50eXBlID09IEZpZWxkVHlwZS5SQURJTyB8fCBmaWVsZC50eXBlID09IEZpZWxkVHlwZS5EUk9QRE9XTikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBGaWVsZFV0aWxzLnNldE9wdGlvbnNVc2luZ0tleSg8QXV0b2NvbXBsZXRlRmllbGQgfCBSYWRpb0ZpZWxkIHwgQ2hlY2tib3hGaWVsZCB8IERyb3Bkb3duRmllbGQ+ZmllbGQsIG1hc3RlckRhdGFLZXkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzdGF0aWMgc2V0T3B0aW9uc1VzaW5nVmFsdWVzKGxpc3Q6IExpc3QsIGZpZWxkS2V5OiBzdHJpbmcsIGtleU1hcDogS2V5TWFwLCByZWxhb2RBbGw6IGJvb2xlYW4sIHJlY29yZDogYW55KSB7XG4gICAgICAgIGlmICghQ29sbGVjdGlvblV0aWxzLmlzRW1wdHkobGlzdCkgJiYgIUNvbGxlY3Rpb25VdGlscy5pc0VtcHR5KGxpc3QuY29sdW1ucykpIHtcbiAgICAgICAgICAgIGxpc3QuY29sdW1ucy5mb3JFYWNoKGNvbHVtbiA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFDb2xsZWN0aW9uVXRpbHMuaXNFbXB0eShjb2x1bW4pICYmICFDb2xsZWN0aW9uVXRpbHMuaXNFbXB0eShjb2x1bW4uZmllbGRzKSkge1xuICAgICAgICAgICAgICAgICAgICBjb2x1bW4uZmllbGRzLmZvckVhY2goZmllbGQgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGlzTWF0Y2hpbmdEZXBlbmRlbmRLZXlNYXA6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghU3RyaW5nVXRpbHMuaXNFbXB0eSgoPEF1dG9jb21wbGV0ZUZpZWxkIHwgUmFkaW9GaWVsZCB8IENoZWNrYm94RmllbGQgfCBEcm9wZG93bkZpZWxkPmZpZWxkKS5vcHRpb25EZXBlbmRzT24pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gIGdldCBvcHRpb25EZXBlbmRzT24gZmllbGQgdmFsdWVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgb3B0aW9uRGVwZW5kc09uVmFsdWUgPSBGb3JtVXRpbHMuZ2V0VmFsdWVWaWFFdmFsKHJlY29yZCwgKDxBdXRvY29tcGxldGVGaWVsZCB8IFJhZGlvRmllbGQgfCBDaGVja2JveEZpZWxkIHwgRHJvcGRvd25GaWVsZD5maWVsZCkub3B0aW9uRGVwZW5kc09uKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXlNYXAub3B0aW9uRGVwZW5kc09uVmFsdWUgPT0gb3B0aW9uRGVwZW5kc09uVmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNNYXRjaGluZ0RlcGVuZGVuZEtleU1hcCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc01hdGNoaW5nRGVwZW5kZW5kS2V5TWFwID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFDb2xsZWN0aW9uVXRpbHMuaXNFbXB0eShmaWVsZCkgJiYgZmllbGQua2V5ID09IGZpZWxkS2V5ICYmIChmaWVsZC50eXBlID09IEZpZWxkVHlwZS5BVVRPQ09NUExFVEUgfHwgZmllbGQudHlwZSA9PSBGaWVsZFR5cGUuQ0hFQ0tCT1ggfHwgZmllbGQudHlwZSA9PSBGaWVsZFR5cGUuUkFESU8gfHwgZmllbGQudHlwZSA9PSBGaWVsZFR5cGUuRFJPUERPV04pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzTWF0Y2hpbmdEZXBlbmRlbmRLZXlNYXApIHsvL30gfHwgcmVsYW9kQWxsKSAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRmllbGRVdGlscy5zZXRPcHRpb25zVXNpbmdWYWx1ZXMoPEF1dG9jb21wbGV0ZUZpZWxkIHwgUmFkaW9GaWVsZCB8IENoZWNrYm94RmllbGQgfCBEcm9wZG93bkZpZWxkPmZpZWxkLCBrZXlNYXApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgfVxuXG5cbiAgICBzdGF0aWMgZ2V0Q29sdW1uS2V5KGNvbHVtbjogQ29sdW1uKTogc3RyaW5nIHtcbiAgICAgICAgbGV0IGtleTtcbiAgICAgICAgaWYgKGNvbHVtbi5rZXkpIHtcbiAgICAgICAgICAgIGtleSA9IGNvbHVtbi5rZXk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoY29sdW1uLmZpZWxkcyAmJiBjb2x1bW4uZmllbGRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBrZXkgPSBjb2x1bW4uZmllbGRzWzBdLmtleTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBrZXk7XG4gICAgfVxuXG5cbiAgICBzdGF0aWMgZ2V0Q29sdW1uTGFiZWwoY29sdW1uOiBDb2x1bW4pOiBzdHJpbmcge1xuICAgICAgICBsZXQgbGFiZWw7XG4gICAgICAgIGlmIChjb2x1bW4ubGFiZWwpIHtcbiAgICAgICAgICAgIGxhYmVsID0gY29sdW1uLmxhYmVsO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGNvbHVtbi5maWVsZHMgJiYgY29sdW1uLmZpZWxkcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgbGFiZWwgPSBjb2x1bW4uZmllbGRzWzBdLmxhYmVsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGxhYmVsO1xuICAgIH1cblxuICAgIHN0YXRpYyBnZXRDb2x1bW5TZWxlY3RvckZpZWxkKGxpc3RDb25maWc6IExpc3QpOiBEcm9wZG93bkZpZWxkIHtcbiAgICAgICAgbGV0IG9wdGlvbnM6IEFycmF5PERyb3Bkb3duT3B0aW9uPiA9IG5ldyBBcnJheTxEcm9wZG93bk9wdGlvbj4oKTtcblxuICAgICAgICBsZXQgdmFsdWVzOiBBcnJheTxzdHJpbmc+ID0gbmV3IEFycmF5PHN0cmluZz4oKTtcbiAgICAgICAgZm9yIChsZXQgY29sdW1uIG9mIGxpc3RDb25maWcuY29sdW1ucykge1xuICAgICAgICAgICAgbGV0IGtleTogc3RyaW5nID0gdGhpcy5nZXRDb2x1bW5LZXkoY29sdW1uKTtcbiAgICAgICAgICAgIGxldCBsYWJlbDogc3RyaW5nID0gdGhpcy5nZXRDb2x1bW5MYWJlbChjb2x1bW4pO1xuXG4gICAgICAgICAgICBvcHRpb25zLnB1c2goe1xuICAgICAgICAgICAgICAgIGtleToga2V5LFxuICAgICAgICAgICAgICAgIHZhbHVlOiBsYWJlbCxcbiAgICAgICAgICAgICAgICBkaXNhYmxlZDogZmFsc2UsXG4gICAgICAgICAgICAgICAgc2VsZWN0ZWQ6IGNvbHVtbi5zaG93XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKGNvbHVtbi5zaG93KSB7XG4gICAgICAgICAgICAgICAgdmFsdWVzLnB1c2goa2V5KVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGNvbHVtblNlbGVjdG9yRmllbGQ6IERyb3Bkb3duRmllbGQgPSB7XG4gICAgICAgICAgICBrZXk6IFwiY29sdW1uU2VsZWN0b3JcIixcbiAgICAgICAgICAgIGxhYmVsOiBcIkRpc3BsYXkgQ29sdW1uXCIsXG4gICAgICAgICAgICB0eXBlOiBGaWVsZFR5cGUuRFJPUERPV04sXG4gICAgICAgICAgICBhcHBlYXJhbmNlOiBGaWVsZEFwcGVhcmFuY2UuU1RBTkRBUkQsXG4gICAgICAgICAgICBpc1JlYWRPbmx5OiBmYWxzZSxcbiAgICAgICAgICAgIGZpZWxkRGlzcGxheVR5cGU6IEZpZWxkRGlhcGx5VHlwZS5JTkxJTkUsXG4gICAgICAgICAgICBwbGFjZWhvbGRlcjogXCJDb2x1bW5zIHRvIGRpc3BsYXlcIixcbiAgICAgICAgICAgIG9wdGlvbnM6IG9wdGlvbnMsXG4gICAgICAgICAgICBtdWx0aXNlbGVjdDogdHJ1ZSxcbiAgICAgICAgICAgIHZhbHVlOiB2YWx1ZXNcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gY29sdW1uU2VsZWN0b3JGaWVsZDtcbiAgICB9XG5cbiAgICBzdGF0aWMgZ2V0TW9iaWxlQ29uZmlnKGxpc3RDb25maWc6IExpc3QpIHtcbiAgICAgICAgaWYgKCFDb2xsZWN0aW9uVXRpbHMuaXNFbXB0eShsaXN0Q29uZmlnKSAmJiAhQ29sbGVjdGlvblV0aWxzLmlzRW1wdHkobGlzdENvbmZpZy5tb2JpbGUpICYmICFDb2xsZWN0aW9uVXRpbHMuaXNFbXB0eShsaXN0Q29uZmlnLm1vYmlsZS5jZWxscykpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0Q3VzdG9tTGF5b3V0KGxpc3RDb25maWcsIGxpc3RDb25maWcubW9iaWxlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHN0YXRpYyBzZXRDdXN0b21MYXlvdXRzKGxpc3RDb25maWc6IExpc3QpIHtcbiAgICAgICAgaWYgKHRoaXMuaGFzUm93SG92ZXIobGlzdENvbmZpZykpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0Q3VzdG9tTGF5b3V0KGxpc3RDb25maWcsIGxpc3RDb25maWcucm93LmhvdmVyLnRlbXBsYXRlLmxheW91dCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuaGFzQ3VzdG9tQ2VsbExheW91dChsaXN0Q29uZmlnKSkge1xuICAgICAgICAgICAgbGlzdENvbmZpZy5jb2x1bW5zLmZvckVhY2goY29sdW1uID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoY29sdW1uLnRlbXBsYXRlICYmIGNvbHVtbi50ZW1wbGF0ZS5sYXlvdXQpICB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0Q3VzdG9tTGF5b3V0KGxpc3RDb25maWcsIGNvbHVtbi50ZW1wbGF0ZS5sYXlvdXQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuaGFzQ3VzdG9tUm93TGF5b3V0KGxpc3RDb25maWcpKSB7XG4gICAgICAgICAgICB0aGlzLnNldEN1c3RvbUxheW91dChsaXN0Q29uZmlnLCBsaXN0Q29uZmlnLnJvdy50ZW1wbGF0ZS5sYXlvdXQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc3RhdGljIGhhc1Jvd0hvdmVyKGxpc3RDb25maWc6IExpc3QpOiBib29sZWFuIHtcbiAgICAgICAgbGV0IGhhc0hvdmVyQ29uZmlnOiBib29sZWFuID0gZmFsc2U7XG4gICAgICAgIFxuICAgICAgICBpZiAobGlzdENvbmZpZyAmJiBsaXN0Q29uZmlnLnJvdyAmJiBsaXN0Q29uZmlnLnJvdy5ob3ZlciAmJiBsaXN0Q29uZmlnLnJvdy5ob3Zlci50ZW1wbGF0ZSAmJiBsaXN0Q29uZmlnLnJvdy5ob3Zlci50ZW1wbGF0ZS5sYXlvdXQpICB7XG4gICAgICAgICAgICBoYXNIb3ZlckNvbmZpZyA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gaGFzSG92ZXJDb25maWc7XG4gICAgfVxuXG4gICAgc3RhdGljIGhhc0N1c3RvbVJvd0xheW91dChsaXN0Q29uZmlnOiBMaXN0KTogYm9vbGVhbiB7XG4gICAgICAgIGxldCBoYXNDdXN0b21Sb3dMYXlvdXQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgIGlmIChsaXN0Q29uZmlnICYmIGxpc3RDb25maWcucm93ICYmIGxpc3RDb25maWcucm93LnRlbXBsYXRlICYmIGxpc3RDb25maWcucm93LnRlbXBsYXRlLmxheW91dCkgIHtcbiAgICAgICAgICAgIGhhc0N1c3RvbVJvd0xheW91dCA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHJldHVybiBoYXNDdXN0b21Sb3dMYXlvdXQ7XG4gICAgfVxuXG4gICAgc3RhdGljIGhhc0N1c3RvbUNlbGxMYXlvdXQobGlzdENvbmZpZzogTGlzdCk6IGJvb2xlYW4ge1xuICAgICAgICBsZXQgaGFzQ3VzdG9tQ2VsbExheW91dDogYm9vbGVhbiA9IGZhbHNlO1xuICAgICAgICBcbiAgICAgICAgaWYgKGxpc3RDb25maWcgJiYgIUNvbGxlY3Rpb25VdGlscy5pc0VtcHR5KGxpc3RDb25maWcuY29sdW1ucykpICB7XG4gICAgICAgICAgICBsaXN0Q29uZmlnLmNvbHVtbnMuZm9yRWFjaChjb2x1bW4gPT4ge1xuICAgICAgICAgICAgICAgIGlmIChjb2x1bW4udGVtcGxhdGUgJiYgY29sdW1uLnRlbXBsYXRlLmxheW91dCkgIHtcbiAgICAgICAgICAgICAgICAgICAgaGFzQ3VzdG9tQ2VsbExheW91dCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIGhhc0N1c3RvbUNlbGxMYXlvdXQ7XG4gICAgfVxuXG4gICAgc3RhdGljIHNldEN1c3RvbUxheW91dChsaXN0Q29uZmlnOiBMaXN0LCBsYXlvdXQ6IExpc3RDdXN0b21MYXlvdXQpIHtcbiAgICAgICAgaWYgKGxheW91dCAmJiAhQ29sbGVjdGlvblV0aWxzLmlzRW1wdHkobGF5b3V0LmNlbGxzKSkge1xuICAgICAgICAgICAgbGF5b3V0LmNlbGxzLmZvckVhY2goY2VsbCA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFDb2xsZWN0aW9uVXRpbHMuaXNFbXB0eShjZWxsLmNvbnRyb2xzKSkge1xuICAgICAgICAgICAgICAgICAgICBjZWxsLmNvbnRyb2xzLmZvckVhY2goY29udHJvbCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoQ29sbGVjdGlvblV0aWxzLmlzRW1wdHkoY29udHJvbC5jb250cm9sKSkgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJlc29sdmVkQ29udHJvbDogeyBjb250cm9sPzogYW55LCBjb2xJbmRleD86IG51bWJlciwgY0NvbnRyb2xJbmRleD86IG51bWJlciB9ID0ge307XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZWRDb250cm9sID0gdGhpcy5nZXRDb250cm9sKGxpc3RDb25maWcsIGNvbnRyb2wpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbC5jb250cm9sID0gcmVzb2x2ZWRDb250cm9sLmNvbnRyb2w7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbC5jb2xJbmRleCA9IHJlc29sdmVkQ29udHJvbC5jb2xJbmRleDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sLmNDb250cm9sSW5kZXggPSByZXNvbHZlZENvbnRyb2wuY0NvbnRyb2xJbmRleDtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIChjb250cm9sLnR5cGUgPT0gQ2VsbENvbnRyb2xsVHlwZS5CVVRUT04gJiYgY29udHJvbC5jb250cm9sWyd0eXBlJ10gPT0gQnV0dG9uVHlwZS5DSElQKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgIGNvbnRyb2wuY29udHJvbFsnZ3JvdXBJZGVudGlmaWVyJ10gPSBjb250cm9sLmNvbnRyb2wuaWRlbnRpZmllciArIGNlbGwucm93cyArIGNlbGwuY29scztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzdGF0aWMgZ2V0Q29udHJvbChsaXN0Q29uZmlnOiBMaXN0LCBjZWxsQ29udHJvbDogQ2VsbENvbnRyb2wpOiB7IGNvbnRyb2w/OiBhbnksIGNvbEluZGV4PzogbnVtYmVyLCBjQ29udHJvbEluZGV4PzogbnVtYmVyIH0ge1xuICAgICAgICBsZXQgY29udHJvbDogeyBjb250cm9sPzogYW55LCBjb2xJbmRleD86IG51bWJlciwgY0NvbnRyb2xJbmRleD86IG51bWJlciB9ID0ge307XG5cbiAgICAgICAgaWYgKGNlbGxDb250cm9sLmNvbnRyb2wpIHtcbiAgICAgICAgICAgIGNvbnRyb2wgPSB7IGNvbnRyb2w6IGNlbGxDb250cm9sLmNvbnRyb2wsIGNvbEluZGV4OiAwLCBjQ29udHJvbEluZGV4OiAwIH07XG4gICAgICAgIH0gZWxzZSBpZiAoIUNvbGxlY3Rpb25VdGlscy5pc0VtcHR5KGxpc3RDb25maWcpICYmICFDb2xsZWN0aW9uVXRpbHMuaXNFbXB0eShsaXN0Q29uZmlnLmNvbHVtbnMpICYmIGNlbGxDb250cm9sLnR5cGUgPT0gQ2VsbENvbnRyb2xsVHlwZS5GSUVMRCkge1xuICAgICAgICAgICAgY29udHJvbCA9IHRoaXMuZ2V0Q29sdW1uQ29udHJvbChsaXN0Q29uZmlnLmNvbHVtbnMsIGNlbGxDb250cm9sLmtleSk7XG4gICAgICAgIH0gZWxzZSBpZiAoIUNvbGxlY3Rpb25VdGlscy5pc0VtcHR5KGxpc3RDb25maWcpICYmICFDb2xsZWN0aW9uVXRpbHMuaXNFbXB0eShsaXN0Q29uZmlnLmFjdGlvbnMpICYmIGNlbGxDb250cm9sLnR5cGUgPT0gQ2VsbENvbnRyb2xsVHlwZS5CVVRUT04pIHtcbiAgICAgICAgICAgIGNvbnRyb2wuY29udHJvbCA9IHRoaXMuZ2V0QnV0dG9uQ29udHJvbChsaXN0Q29uZmlnLmFjdGlvbnMsIGNlbGxDb250cm9sLmtleSk7XG4gICAgICAgICAgICBjb250cm9sLmNvbEluZGV4ID0gbGlzdENvbmZpZy5jb2x1bW5zLmxlbmd0aDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBjb250cm9sO1xuICAgIH1cblxuICAgIHN0YXRpYyBnZXRDb2x1bW5Db250cm9sKGNvbHVtbnM6IEFycmF5PENvbHVtbj4sIGNvbnRyb2xLZXk6IHN0cmluZyk6IHsgY29udHJvbD86IGFueSwgY29sSW5kZXg/OiBudW1iZXIsIGNDb250cm9sSW5kZXg/OiBudW1iZXIgfSB7XG4gICAgICAgIGxldCBjb250cm9sOiB7IGNvbnRyb2w/OiBhbnksIGNvbEluZGV4PzogbnVtYmVyLCBjQ29udHJvbEluZGV4PzogbnVtYmVyIH0gPSB7fTtcblxuICAgICAgICBsZXQgY29sSW5kZXggPSAwO1xuICAgICAgICBjb2x1bW5zLmZvckVhY2goY29sdW1uID0+IHtcbiAgICAgICAgICAgIGlmICghQ29sbGVjdGlvblV0aWxzLmlzRW1wdHkoY29sdW1uLmZpZWxkcykgJiYgQ29sbGVjdGlvblV0aWxzLmlzRW1wdHkoY29udHJvbC5jb250cm9sKSkge1xuICAgICAgICAgICAgICAgIGxldCBjQ29udHJvbEluZGV4ID0gMDtcbiAgICAgICAgICAgICAgICBjb2x1bW4uZmllbGRzLmZvckVhY2goZmllbGQgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoQ29sbGVjdGlvblV0aWxzLmlzRW1wdHkoY29udHJvbC5jb250cm9sKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbCA9IExpc3RVdGlscy5nZXRGaWVsZENvbnRyb2woZmllbGQsIGNvbnRyb2xLZXksIGNvbEluZGV4LCBjQ29udHJvbEluZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNDb250cm9sSW5kZXgrKztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb2xJbmRleCsrO1xuICAgICAgICB9KVxuXG4gICAgICAgIHJldHVybiBjb250cm9sO1xuICAgIH1cblxuICAgIHN0YXRpYyBnZXRGaWVsZENvbnRyb2woZmllbGQ6IGFueSwgY29udHJvbEtleTogc3RyaW5nLCBjb2xJbmRleDogbnVtYmVyLCBjQ29udHJvbEluZGV4OiBudW1iZXIpOiB7IGNvbnRyb2w/OiBhbnksIGNvbEluZGV4PzogbnVtYmVyLCBjQ29udHJvbEluZGV4PzogbnVtYmVyIH0ge1xuICAgICAgICBsZXQgY29udHJvbDogeyBjb250cm9sPzogYW55LCBjb2xJbmRleD86IG51bWJlciwgY0NvbnRyb2xJbmRleD86IG51bWJlciB9ID0ge307XG5cbiAgICAgICAgaWYgKGZpZWxkLmtleSA9PSBjb250cm9sS2V5KSB7XG4gICAgICAgICAgICBjb250cm9sLmNvbnRyb2wgPSBmaWVsZDtcbiAgICAgICAgICAgIGNvbnRyb2wuY29sSW5kZXggPSBjb2xJbmRleDtcbiAgICAgICAgICAgIGNvbnRyb2wuY0NvbnRyb2xJbmRleCA9IGNDb250cm9sSW5kZXg7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIjExMTExMTFcIik7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhjb250cm9sKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBjb250cm9sO1xuICAgIH1cblxuICAgIHN0YXRpYyBnZXRCdXR0b25Db250cm9sKGJ1dHRvbnM6IEFycmF5PEJ1dHRvbj4sIGNvbnRyb2xLZXk6IHN0cmluZyk6IGFueSB7XG4gICAgICAgIGxldCBjb250cm9sOiBhbnk7XG5cbiAgICAgICAgYnV0dG9ucy5mb3JFYWNoKGJ1dHRvbiA9PiB7XG4gICAgICAgICAgICBpZiAoYnV0dG9uLmlkZW50aWZpZXIgPT0gY29udHJvbEtleSkge1xuICAgICAgICAgICAgICAgIGNvbnRyb2wgPSBidXR0b247XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG5cbiAgICAgICAgcmV0dXJuIGNvbnRyb2w7XG4gICAgfVxufSJdfQ==