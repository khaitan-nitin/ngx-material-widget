import { CollectionUtils, FormUtils } from '.';
import { FieldUtils } from './field.utility';
import { StringUtils } from './string.utility';
export class ListUtils {
    static addColoumn() {
    }
    static hideColoumn() {
    }
    static setOptionsUsingKey(list, fieldKey, masterDataKey) {
        if (!CollectionUtils.isEmpty(list) && !CollectionUtils.isEmpty(list.columns)) {
            list.columns.forEach(column => {
                if (!CollectionUtils.isEmpty(column) && !CollectionUtils.isEmpty(column.fields)) {
                    column.fields.forEach(field => {
                        if (!CollectionUtils.isEmpty(field) && field.key == fieldKey && (field.type == "AUTOCOMPLETE" /* AUTOCOMPLETE */ || field.type == "CHECKBOX" /* CHECKBOX */ || field.type == "RADIO" /* RADIO */ || field.type == "DROPDOWN" /* DROPDOWN */)) {
                            FieldUtils.setOptionsUsingKey(field, masterDataKey);
                        }
                    });
                }
            });
        }
    }
    static setOptionsUsingValues(list, fieldKey, keyMap, relaodAll, record) {
        if (!CollectionUtils.isEmpty(list) && !CollectionUtils.isEmpty(list.columns)) {
            list.columns.forEach(column => {
                if (!CollectionUtils.isEmpty(column) && !CollectionUtils.isEmpty(column.fields)) {
                    column.fields.forEach(field => {
                        let isMatchingDependendKeyMap = false;
                        if (!StringUtils.isEmpty(field.optionDependsOn)) {
                            //  get optionDependsOn field value
                            let optionDependsOnValue = FormUtils.getValueViaEval(record, field.optionDependsOn);
                            if (keyMap.optionDependsOnValue == optionDependsOnValue) {
                                isMatchingDependendKeyMap = true;
                            }
                        }
                        else {
                            isMatchingDependendKeyMap = true;
                        }
                        if (!CollectionUtils.isEmpty(field) && field.key == fieldKey && (field.type == "AUTOCOMPLETE" /* AUTOCOMPLETE */ || field.type == "CHECKBOX" /* CHECKBOX */ || field.type == "RADIO" /* RADIO */ || field.type == "DROPDOWN" /* DROPDOWN */)) {
                            if (isMatchingDependendKeyMap) { //} || relaodAll)   {
                                FieldUtils.setOptionsUsingValues(field, keyMap);
                            }
                        }
                    });
                }
            });
        }
    }
    static getColumnKey(column) {
        let key;
        if (column.key) {
            key = column.key;
        }
        else {
            if (column.fields && column.fields.length > 0) {
                key = column.fields[0].key;
            }
        }
        return key;
    }
    static getColumnLabel(column) {
        let label;
        if (column.label) {
            label = column.label;
        }
        else {
            if (column.fields && column.fields.length > 0) {
                label = column.fields[0].label;
            }
        }
        return label;
    }
    static getColumnSelectorField(listConfig) {
        let options = new Array();
        let values = new Array();
        for (let column of listConfig.columns) {
            let key = this.getColumnKey(column);
            let label = this.getColumnLabel(column);
            options.push({
                key: key,
                value: label,
                disabled: false,
                selected: column.show
            });
            if (column.show) {
                values.push(key);
            }
        }
        let columnSelectorField = {
            key: "columnSelector",
            label: "Display Column",
            type: "DROPDOWN" /* DROPDOWN */,
            appearance: "STANDARD" /* STANDARD */,
            isReadOnly: false,
            fieldDisplayType: "INLINE" /* INLINE */,
            placeholder: "Columns to display",
            options: options,
            multiselect: true,
            value: values
        };
        return columnSelectorField;
    }
    static getMobileConfig(listConfig) {
        if (!CollectionUtils.isEmpty(listConfig) && !CollectionUtils.isEmpty(listConfig.mobile) && !CollectionUtils.isEmpty(listConfig.mobile.cells)) {
            this.setCustomLayout(listConfig, listConfig.mobile);
        }
    }
    static setCustomLayouts(listConfig) {
        if (this.hasRowHover(listConfig)) {
            this.setCustomLayout(listConfig, listConfig.row.hover.template.layout);
        }
        if (this.hasCustomCellLayout(listConfig)) {
            listConfig.columns.forEach(column => {
                if (column.template && column.template.layout) {
                    this.setCustomLayout(listConfig, column.template.layout);
                }
            });
        }
        if (this.hasCustomRowLayout(listConfig)) {
            this.setCustomLayout(listConfig, listConfig.row.template.layout);
        }
    }
    static hasRowHover(listConfig) {
        let hasHoverConfig = false;
        if (listConfig && listConfig.row && listConfig.row.hover && listConfig.row.hover.template && listConfig.row.hover.template.layout) {
            hasHoverConfig = true;
        }
        return hasHoverConfig;
    }
    static hasCustomRowLayout(listConfig) {
        let hasCustomRowLayout = false;
        if (listConfig && listConfig.row && listConfig.row.template && listConfig.row.template.layout) {
            hasCustomRowLayout = true;
        }
        return hasCustomRowLayout;
    }
    static hasCustomCellLayout(listConfig) {
        let hasCustomCellLayout = false;
        if (listConfig && !CollectionUtils.isEmpty(listConfig.columns)) {
            listConfig.columns.forEach(column => {
                if (column.template && column.template.layout) {
                    hasCustomCellLayout = true;
                }
            });
        }
        return hasCustomCellLayout;
    }
    static setCustomLayout(listConfig, layout) {
        if (layout && !CollectionUtils.isEmpty(layout.cells)) {
            layout.cells.forEach(cell => {
                if (!CollectionUtils.isEmpty(cell.controls)) {
                    cell.controls.forEach(control => {
                        if (CollectionUtils.isEmpty(control.control)) {
                            let resolvedControl = {};
                            resolvedControl = this.getControl(listConfig, control);
                            control.control = resolvedControl.control;
                            control.colIndex = resolvedControl.colIndex;
                            control.cControlIndex = resolvedControl.cControlIndex;
                            // if (control.type == CellControllType.BUTTON && control.control['type'] == ButtonType.CHIP) {
                            //     control.control['groupIdentifier'] = control.control.identifier + cell.rows + cell.cols;
                            // }
                        }
                    });
                }
            });
        }
    }
    static getControl(listConfig, cellControl) {
        let control = {};
        if (cellControl.control) {
            control = { control: cellControl.control, colIndex: 0, cControlIndex: 0 };
        }
        else if (!CollectionUtils.isEmpty(listConfig) && !CollectionUtils.isEmpty(listConfig.columns) && cellControl.type == "FIELD" /* FIELD */) {
            control = this.getColumnControl(listConfig.columns, cellControl.key);
        }
        else if (!CollectionUtils.isEmpty(listConfig) && !CollectionUtils.isEmpty(listConfig.actions) && cellControl.type == "BUTTON" /* BUTTON */) {
            control.control = this.getButtonControl(listConfig.actions, cellControl.key);
            control.colIndex = listConfig.columns.length;
        }
        return control;
    }
    static getColumnControl(columns, controlKey) {
        let control = {};
        let colIndex = 0;
        columns.forEach(column => {
            if (!CollectionUtils.isEmpty(column.fields) && CollectionUtils.isEmpty(control.control)) {
                let cControlIndex = 0;
                column.fields.forEach(field => {
                    if (CollectionUtils.isEmpty(control.control)) {
                        control = ListUtils.getFieldControl(field, controlKey, colIndex, cControlIndex);
                        cControlIndex++;
                    }
                });
            }
            colIndex++;
        });
        return control;
    }
    static getFieldControl(field, controlKey, colIndex, cControlIndex) {
        let control = {};
        if (field.key == controlKey) {
            control.control = field;
            control.colIndex = colIndex;
            control.cControlIndex = cControlIndex;
            console.log("1111111");
            console.log(control);
        }
        return control;
    }
    static getButtonControl(buttons, controlKey) {
        let control;
        buttons.forEach(button => {
            if (button.identifier == controlKey) {
                control = button;
            }
        });
        return control;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdC51dGlsaXR5LmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9uaXRpbmtoYWl0YW4vTml0aW4vc3R1ZHkvYW5ndWxhci9tYXRlcmlhbC9hZG1pbi1idWlsZGVyLXBsdWdpbi9wcm9qZWN0cy9uZ3gtbWF0ZXJpYWwtd2lkZ2V0L3NyYy8iLCJzb3VyY2VzIjpbImxpYi91dGlsaXR5L2xpc3QudXRpbGl0eS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsZUFBZSxFQUFFLFNBQVMsRUFBRSxNQUFNLEdBQUcsQ0FBQztBQUUvQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDN0MsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRy9DLE1BQU0sT0FBTyxTQUFTO0lBQ2xCLE1BQU0sQ0FBQyxVQUFVO0lBRWpCLENBQUM7SUFFRCxNQUFNLENBQUMsV0FBVztJQUVsQixDQUFDO0lBRUQsTUFBTSxDQUFDLGtCQUFrQixDQUFDLElBQVUsRUFBRSxRQUFnQixFQUFFLGFBQXFCO1FBQ3pFLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDMUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUU7Z0JBQzFCLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUU7b0JBQzdFLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFO3dCQUMxQixJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxLQUFLLENBQUMsR0FBRyxJQUFJLFFBQVEsSUFBSSxDQUFDLEtBQUssQ0FBQyxJ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QUM7cUJBQ25CO2dCQUNMLENBQUMsQ0FBQyxDQUFBO2FBQ0w7WUFDRCxRQUFRLEVBQUUsQ0FBQztRQUNmLENBQUMsQ0FBQyxDQUFBO1FBRUYsT0FBTyxPQUFPLENBQUM7SUFDbkIsQ0FBQztJQUVELE1BQU0sQ0FBQyxlQUFlLENBQUMsS0FBVSxFQUFFLFVBQWtCLEVBQUUsUUFBZ0IsRUFBRSxhQUFxQjtRQUMxRixJQUFJLE9BQU8sR0FBaUUsRUFBRSxDQUFDO1FBRS9FLElBQUksS0FBSyxDQUFDLEdBQUcsSUFBSSxVQUFVLEVBQUU7WUFDekIsT0FBTyxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7WUFDeEIsT0FBTyxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7WUFDNUIsT0FBTyxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUM7WUFDdEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUN2QixPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ3hCO1FBRUQsT0FBTyxPQUFPLENBQUM7SUFDbkIsQ0FBQztJQUVELE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFzQixFQUFFLFVBQWtCO1FBQzlELElBQUksT0FBWSxDQUFDO1FBRWpCLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDckIsSUFBSSxNQUFNLENBQUMsVUFBVSxJQUFJLFVBQVUsRUFBRTtnQkFDakMsT0FBTyxHQUFHLE1BQU0sQ0FBQzthQUNwQjtRQUNMLENBQUMsQ0FBQyxDQUFBO1FBRUYsT0FBTyxPQUFPLENBQUM7SUFDbkIsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2VsbENvbnRyb2wsIENlbGxDb250cm9sbFR5cGUsIENvbHVtbiwgTGlzdCwgTGlzdEN1c3RvbUxheW91dCB9IGZyb20gJy4uL2xpc3QvbW9kZWwnO1xuaW1wb3J0IHsgQ29sbGVjdGlvblV0aWxzLCBGb3JtVXRpbHMgfSBmcm9tICcuJztcbmltcG9ydCB7IEZpZWxkVHlwZSwgQXV0b2NvbXBsZXRlRmllbGQsIFJhZGlvRmllbGQsIENoZWNrYm94RmllbGQsIERyb3Bkb3duRmllbGQsIERyb3Bkb3duT3B0aW9uLCBLZXlNYXAsIEZpZWxkQXBwZWFyYW5jZSwgRmllbGREaWFwbHlUeXBlIH0gZnJvbSAnLi4vZmllbGQvbW9kZWwnO1xuaW1wb3J0IHsgRmllbGRVdGlscyB9IGZyb20gJy4vZmllbGQudXRpbGl0eSc7XG5pbXBvcnQgeyBTdHJpbmdVdGlscyB9IGZyb20gJy4vc3RyaW5nLnV0aWxpdHknO1xuaW1wb3J0IHsgQnV0dG9uLCBCdXR0b25UeXBlIH0gZnJvbSAnLi4vYnV0dG9uL21vZGVsJztcblxuZXhwb3J0IGNsYXNzIExpc3RVdGlscyB7XG4gICAgc3RhdGljIGFkZENvbG91bW4oKSB7XG5cbiAgICB9XG5cbiAgICBzdGF0aWMgaGlkZUNvbG91bW4oKSB7XG5cbiAgICB9XG5cbiAgICBzdGF0aWMgc2V0T3B0aW9uc1VzaW5nS2V5KGxpc3Q6IExpc3QsIGZpZWxkS2V5OiBzdHJpbmcsIG1hc3RlckRhdGFLZXk6IHN0cmluZykge1xuICAgICAgICBpZiAoIUNvbGxlY3Rpb25VdGlscy5pc0VtcHR5KGxpc3QpICYmICFDb2xsZWN0aW9uVXRpbHMuaXNFbXB0eShsaXN0LmNvbHVtbnMpKSB7XG4gICAgICAgICAgICBsaXN0LmNvbHVtbnMuZm9yRWFjaChjb2x1bW4gPT4ge1xuICAgICAgICAgICAgICAgIGlmICghQ29sbGVjdGlvblV0aWxzLmlzRW1wdHkoY29sdW1uKSAmJiAhQ29sbGVjdGlvblV0aWxzLmlzRW1wdHkoY29sdW1uLmZpZWxkcykpIHtcbiAgICAgICAgICAgICAgICAgICAgY29sdW1uLmZpZWxkcy5mb3JFYWNoKGZpZWxkID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghQ29sbGVjdGlvblV0aWxzLmlzRW1wdHkoZmllbGQpICYmIGZpZWxkLmtleSA9PSBmaWVsZEtleSAmJiAoZmllbGQudHlwZSA9PSBGaWVsZFR5cGUuQVVUT0NPTVBMRVRFIHx8IGZpZWxkLnR5cGUgPT0gRmllbGRUeXBlLkNIRUNLQk9YIHx8IGZpZWxkLnR5cGUgPT0gRmllbGRUeXBlLlJBRElPIHx8IGZpZWxkLnR5cGUgPT0gRmllbGRUeXBlLkRST1BET1dOKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZpZWxkVXRpbHMuc2V0T3B0aW9uc1VzaW5nS2V5KDxBdXRvY29tcGxldGVGaWVsZCB8IFJhZGlvRmllbGQgfCBDaGVja2JveEZpZWxkIHwgRHJvcGRvd25GaWVsZD5maWVsZCwgbWFzdGVyRGF0YUtleSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHN0YXRpYyBzZXRPcHRpb25zVXNpbmdWYWx1ZXMobGlzdDogTGlzdCwgZmllbGRLZXk6IHN0cmluZywga2V5TWFwOiBLZXlNYXAsIHJlbGFvZEFsbDogYm9vbGVhbiwgcmVjb3JkOiBhbnkpIHtcbiAgICAgICAgaWYgKCFDb2xsZWN0aW9uVXRpbHMuaXNFbXB0eShsaXN0KSAmJiAhQ29sbGVjdGlvblV0aWxzLmlzRW1wdHkobGlzdC5jb2x1bW5zKSkge1xuICAgICAgICAgICAgbGlzdC5jb2x1bW5zLmZvckVhY2goY29sdW1uID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIUNvbGxlY3Rpb25VdGlscy5pc0VtcHR5KGNvbHVtbikgJiYgIUNvbGxlY3Rpb25VdGlscy5pc0VtcHR5KGNvbHVtbi5maWVsZHMpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbHVtbi5maWVsZHMuZm9yRWFjaChmaWVsZCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgaXNNYXRjaGluZ0RlcGVuZGVuZEtleU1hcDogYm9vbGVhbiA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFTdHJpbmdVdGlscy5pc0VtcHR5KCg8QXV0b2NvbXBsZXRlRmllbGQgfCBSYWRpb0ZpZWxkIHwgQ2hlY2tib3hGaWVsZCB8IERyb3Bkb3duRmllbGQ+ZmllbGQpLm9wdGlvbkRlcGVuZHNPbikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgZ2V0IG9wdGlvbkRlcGVuZHNPbiBmaWVsZCB2YWx1ZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBvcHRpb25EZXBlbmRzT25WYWx1ZSA9IEZvcm1VdGlscy5nZXRWYWx1ZVZpYUV2YWwocmVjb3JkLCAoPEF1dG9jb21wbGV0ZUZpZWxkIHwgUmFkaW9GaWVsZCB8IENoZWNrYm94RmllbGQgfCBEcm9wZG93bkZpZWxkPmZpZWxkKS5vcHRpb25EZXBlbmRzT24pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtleU1hcC5vcHRpb25EZXBlbmRzT25WYWx1ZSA9PSBvcHRpb25EZXBlbmRzT25WYWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc01hdGNoaW5nRGVwZW5kZW5kS2V5TWFwID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzTWF0Y2hpbmdEZXBlbmRlbmRLZXlNYXAgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIUNvbGxlY3Rpb25VdGlscy5pc0VtcHR5KGZpZWxkKSAmJiBmaWVsZC5rZXkgPT0gZmllbGRLZXkgJiYgKGZpZWxkLnR5cGUgPT0gRmllbGRUeXBlLkFVVE9DT01QTEVURSB8fCBmaWVsZC50eXBlID09IEZpZWxkVHlwZS5DSEVDS0JPWCB8fCBmaWVsZC50eXBlID09IEZpZWxkVHlwZS5SQURJTyB8fCBmaWVsZC50eXBlID09IEZpZWxkVHlwZS5EUk9QRE9XTikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNNYXRjaGluZ0RlcGVuZGVuZEtleU1hcCkgey8vfSB8fCByZWxhb2RBbGwpICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBGaWVsZFV0aWxzLnNldE9wdGlvbnNVc2luZ1ZhbHVlcyg8QXV0b2NvbXBsZXRlRmllbGQgfCBSYWRpb0ZpZWxkIHwgQ2hlY2tib3hGaWVsZCB8IERyb3Bkb3duRmllbGQ+ZmllbGQsIGtleU1hcCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICB9XG5cblxuICAgIHN0YXRpYyBnZXRDb2x1bW5LZXkoY29sdW1uOiBDb2x1bW4pOiBzdHJpbmcge1xuICAgICAgICBsZXQga2V5O1xuICAgICAgICBpZiAoY29sdW1uLmtleSkge1xuICAgICAgICAgICAga2V5ID0gY29sdW1uLmtleTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChjb2x1bW4uZmllbGRzICYmIGNvbHVtbi5maWVsZHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIGtleSA9IGNvbHVtbi5maWVsZHNbMF0ua2V5O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGtleTtcbiAgICB9XG5cblxuICAgIHN0YXRpYyBnZXRDb2x1bW5MYWJlbChjb2x1bW46IENvbHVtbik6IHN0cmluZyB7XG4gICAgICAgIGxldCBsYWJlbDtcbiAgICAgICAgaWYgKGNvbHVtbi5sYWJlbCkge1xuICAgICAgICAgICAgbGFiZWwgPSBjb2x1bW4ubGFiZWw7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoY29sdW1uLmZpZWxkcyAmJiBjb2x1bW4uZmllbGRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBsYWJlbCA9IGNvbHVtbi5maWVsZHNbMF0ubGFiZWw7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbGFiZWw7XG4gICAgfVxuXG4gICAgc3RhdGljIGdldENvbHVtblNlbGVjdG9yRmllbGQobGlzdENvbmZpZzogTGlzdCk6IERyb3Bkb3duRmllbGQge1xuICAgICAgICBsZXQgb3B0aW9uczogQXJyYXk8RHJvcGRvd25PcHRpb24+ID0gbmV3IEFycmF5PERyb3Bkb3duT3B0aW9uPigpO1xuXG4gICAgICAgIGxldCB2YWx1ZXM6IEFycmF5PHN0cmluZz4gPSBuZXcgQXJyYXk8c3RyaW5nPigpO1xuICAgICAgICBmb3IgKGxldCBjb2x1bW4gb2YgbGlzdENvbmZpZy5jb2x1bW5zKSB7XG4gICAgICAgICAgICBsZXQga2V5OiBzdHJpbmcgPSB0aGlzLmdldENvbHVtbktleShjb2x1bW4pO1xuICAgICAgICAgICAgbGV0IGxhYmVsOiBzdHJpbmcgPSB0aGlzLmdldENvbHVtbkxhYmVsKGNvbHVtbik7XG5cbiAgICAgICAgICAgIG9wdGlvbnMucHVzaCh7XG4gICAgICAgICAgICAgICAga2V5OiBrZXksXG4gICAgICAgICAgICAgICAgdmFsdWU6IGxhYmVsLFxuICAgICAgICAgICAgICAgIGRpc2FibGVkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBzZWxlY3RlZDogY29sdW1uLnNob3dcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpZiAoY29sdW1uLnNob3cpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZXMucHVzaChrZXkpXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgY29sdW1uU2VsZWN0b3JGaWVsZDogRHJvcGRvd25GaWVsZCA9IHtcbiAgICAgICAgICAgIGtleTogXCJjb2x1bW5TZWxlY3RvclwiLFxuICAgICAgICAgICAgbGFiZWw6IFwiRGlzcGxheSBDb2x1bW5cIixcbiAgICAgICAgICAgIHR5cGU6IEZpZWxkVHlwZS5EUk9QRE9XTixcbiAgICAgICAgICAgIGFwcGVhcmFuY2U6IEZpZWxkQXBwZWFyYW5jZS5TVEFOREFSRCxcbiAgICAgICAgICAgIGlzUmVhZE9ubHk6IGZhbHNlLFxuICAgICAgICAgICAgZmllbGREaXNwbGF5VHlwZTogRmllbGREaWFwbHlUeXBlLklOTElORSxcbiAgICAgICAgICAgIHBsYWNlaG9sZGVyOiBcIkNvbHVtbnMgdG8gZGlzcGxheVwiLFxuICAgICAgICAgICAgb3B0aW9uczogb3B0aW9ucyxcbiAgICAgICAgICAgIG11bHRpc2VsZWN0OiB0cnVlLFxuICAgICAgICAgICAgdmFsdWU6IHZhbHVlc1xuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiBjb2x1bW5TZWxlY3RvckZpZWxkO1xuICAgIH1cblxuICAgIHN0YXRpYyBnZXRNb2JpbGVDb25maWcobGlzdENvbmZpZzogTGlzdCkge1xuICAgICAgICBpZiAoIUNvbGxlY3Rpb25VdGlscy5pc0VtcHR5KGxpc3RDb25maWcpICYmICFDb2xsZWN0aW9uVXRpbHMuaXNFbXB0eShsaXN0Q29uZmlnLm1vYmlsZSkgJiYgIUNvbGxlY3Rpb25VdGlscy5pc0VtcHR5KGxpc3RDb25maWcubW9iaWxlLmNlbGxzKSkge1xuICAgICAgICAgICAgdGhpcy5zZXRDdXN0b21MYXlvdXQobGlzdENvbmZpZywgbGlzdENvbmZpZy5tb2JpbGUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc3RhdGljIHNldEN1c3RvbUxheW91dHMobGlzdENvbmZpZzogTGlzdCkge1xuICAgICAgICBpZiAodGhpcy5oYXNSb3dIb3ZlcihsaXN0Q29uZmlnKSkge1xuICAgICAgICAgICAgdGhpcy5zZXRDdXN0b21MYXlvdXQobGlzdENvbmZpZywgbGlzdENvbmZpZy5yb3cuaG92ZXIudGVtcGxhdGUubGF5b3V0KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5oYXNDdXN0b21DZWxsTGF5b3V0KGxpc3RDb25maWcpKSB7XG4gICAgICAgICAgICBsaXN0Q29uZmlnLmNvbHVtbnMuZm9yRWFjaChjb2x1bW4gPT4ge1xuICAgICAgICAgICAgICAgIGlmIChjb2x1bW4udGVtcGxhdGUgJiYgY29sdW1uLnRlbXBsYXRlLmxheW91dCkgIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRDdXN0b21MYXlvdXQobGlzdENvbmZpZywgY29sdW1uLnRlbXBsYXRlLmxheW91dCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5oYXNDdXN0b21Sb3dMYXlvdXQobGlzdENvbmZpZykpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0Q3VzdG9tTGF5b3V0KGxpc3RDb25maWcsIGxpc3RDb25maWcucm93LnRlbXBsYXRlLmxheW91dCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzdGF0aWMgaGFzUm93SG92ZXIobGlzdENvbmZpZzogTGlzdCk6IGJvb2xlYW4ge1xuICAgICAgICBsZXQgaGFzSG92ZXJDb25maWc6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgIGlmIChsaXN0Q29uZmlnICYmIGxpc3RDb25maWcucm93ICYmIGxpc3RDb25maWcucm93LmhvdmVyICYmIGxpc3RDb25maWcucm93LmhvdmVyLnRlbXBsYXRlICYmIGxpc3RDb25maWcucm93LmhvdmVyLnRlbXBsYXRlLmxheW91dCkgIHtcbiAgICAgICAgICAgIGhhc0hvdmVyQ29uZmlnID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBoYXNIb3ZlckNvbmZpZztcbiAgICB9XG5cbiAgICBzdGF0aWMgaGFzQ3VzdG9tUm93TGF5b3V0KGxpc3RDb25maWc6IExpc3QpOiBib29sZWFuIHtcbiAgICAgICAgbGV0IGhhc0N1c3RvbVJvd0xheW91dDogYm9vbGVhbiA9IGZhbHNlO1xuICAgICAgICBcbiAgICAgICAgaWYgKGxpc3RDb25maWcgJiYgbGlzdENvbmZpZy5yb3cgJiYgbGlzdENvbmZpZy5yb3cudGVtcGxhdGUgJiYgbGlzdENvbmZpZy5yb3cudGVtcGxhdGUubGF5b3V0KSAge1xuICAgICAgICAgICAgaGFzQ3VzdG9tUm93TGF5b3V0ID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIGhhc0N1c3RvbVJvd0xheW91dDtcbiAgICB9XG5cbiAgICBzdGF0aWMgaGFzQ3VzdG9tQ2VsbExheW91dChsaXN0Q29uZmlnOiBMaXN0KTogYm9vbGVhbiB7XG4gICAgICAgIGxldCBoYXNDdXN0b21DZWxsTGF5b3V0OiBib29sZWFuID0gZmFsc2U7XG4gICAgICAgIFxuICAgICAgICBpZiAobGlzdENvbmZpZyAmJiAhQ29sbGVjdGlvblV0aWxzLmlzRW1wdHkobGlzdENvbmZpZy5jb2x1bW5zKSkgIHtcbiAgICAgICAgICAgIGxpc3RDb25maWcuY29sdW1ucy5mb3JFYWNoKGNvbHVtbiA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGNvbHVtbi50ZW1wbGF0ZSAmJiBjb2x1bW4udGVtcGxhdGUubGF5b3V0KSAge1xuICAgICAgICAgICAgICAgICAgICBoYXNDdXN0b21DZWxsTGF5b3V0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gaGFzQ3VzdG9tQ2VsbExheW91dDtcbiAgICB9XG5cbiAgICBzdGF0aWMgc2V0Q3VzdG9tTGF5b3V0KGxpc3RDb25maWc6IExpc3QsIGxheW91dDogTGlzdEN1c3RvbUxheW91dCkge1xuICAgICAgICBpZiAobGF5b3V0ICYmICFDb2xsZWN0aW9uVXRpbHMuaXNFbXB0eShsYXlvdXQuY2VsbHMpKSB7XG4gICAgICAgICAgICBsYXlvdXQuY2VsbHMuZm9yRWFjaChjZWxsID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIUNvbGxlY3Rpb25VdGlscy5pc0VtcHR5KGNlbGwuY29udHJvbHMpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNlbGwuY29udHJvbHMuZm9yRWFjaChjb250cm9sID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChDb2xsZWN0aW9uVXRpbHMuaXNFbXB0eShjb250cm9sLmNvbnRyb2wpKSAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcmVzb2x2ZWRDb250cm9sOiB7IGNvbnRyb2w/OiBhbnksIGNvbEluZGV4PzogbnVtYmVyLCBjQ29udHJvbEluZGV4PzogbnVtYmVyIH0gPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlZENvbnRyb2wgPSB0aGlzLmdldENvbnRyb2wobGlzdENvbmZpZywgY29udHJvbCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sLmNvbnRyb2wgPSByZXNvbHZlZENvbnRyb2wuY29udHJvbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sLmNvbEluZGV4ID0gcmVzb2x2ZWRDb250cm9sLmNvbEluZGV4O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2wuY0NvbnRyb2xJbmRleCA9IHJlc29sdmVkQ29udHJvbC5jQ29udHJvbEluZGV4O1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgKGNvbnRyb2wudHlwZSA9PSBDZWxsQ29udHJvbGxUeXBlLkJVVFRPTiAmJiBjb250cm9sLmNvbnRyb2xbJ3R5cGUnXSA9PSBCdXR0b25UeXBlLkNISVApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgY29udHJvbC5jb250cm9sWydncm91cElkZW50aWZpZXInXSA9IGNvbnRyb2wuY29udHJvbC5pZGVudGlmaWVyICsgY2VsbC5yb3dzICsgY2VsbC5jb2xzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHN0YXRpYyBnZXRDb250cm9sKGxpc3RDb25maWc6IExpc3QsIGNlbGxDb250cm9sOiBDZWxsQ29udHJvbCk6IHsgY29udHJvbD86IGFueSwgY29sSW5kZXg/OiBudW1iZXIsIGNDb250cm9sSW5kZXg/OiBudW1iZXIgfSB7XG4gICAgICAgIGxldCBjb250cm9sOiB7IGNvbnRyb2w/OiBhbnksIGNvbEluZGV4PzogbnVtYmVyLCBjQ29udHJvbEluZGV4PzogbnVtYmVyIH0gPSB7fTtcblxuICAgICAgICBpZiAoY2VsbENvbnRyb2wuY29udHJvbCkge1xuICAgICAgICAgICAgY29udHJvbCA9IHsgY29udHJvbDogY2VsbENvbnRyb2wuY29udHJvbCwgY29sSW5kZXg6IDAsIGNDb250cm9sSW5kZXg6IDAgfTtcbiAgICAgICAgfSBlbHNlIGlmICghQ29sbGVjdGlvblV0aWxzLmlzRW1wdHkobGlzdENvbmZpZykgJiYgIUNvbGxlY3Rpb25VdGlscy5pc0VtcHR5KGxpc3RDb25maWcuY29sdW1ucykgJiYgY2VsbENvbnRyb2wudHlwZSA9PSBDZWxsQ29udHJvbGxUeXBlLkZJRUxEKSB7XG4gICAgICAgICAgICBjb250cm9sID0gdGhpcy5nZXRDb2x1bW5Db250cm9sKGxpc3RDb25maWcuY29sdW1ucywgY2VsbENvbnRyb2wua2V5KTtcbiAgICAgICAgfSBlbHNlIGlmICghQ29sbGVjdGlvblV0aWxzLmlzRW1wdHkobGlzdENvbmZpZykgJiYgIUNvbGxlY3Rpb25VdGlscy5pc0VtcHR5KGxpc3RDb25maWcuYWN0aW9ucykgJiYgY2VsbENvbnRyb2wudHlwZSA9PSBDZWxsQ29udHJvbGxUeXBlLkJVVFRPTikge1xuICAgICAgICAgICAgY29udHJvbC5jb250cm9sID0gdGhpcy5nZXRCdXR0b25Db250cm9sKGxpc3RDb25maWcuYWN0aW9ucywgY2VsbENvbnRyb2wua2V5KTtcbiAgICAgICAgICAgIGNvbnRyb2wuY29sSW5kZXggPSBsaXN0Q29uZmlnLmNvbHVtbnMubGVuZ3RoO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGNvbnRyb2w7XG4gICAgfVxuXG4gICAgc3RhdGljIGdldENvbHVtbkNvbnRyb2woY29sdW1uczogQXJyYXk8Q29sdW1uPiwgY29udHJvbEtleTogc3RyaW5nKTogeyBjb250cm9sPzogYW55LCBjb2xJbmRleD86IG51bWJlciwgY0NvbnRyb2xJbmRleD86IG51bWJlciB9IHtcbiAgICAgICAgbGV0IGNvbnRyb2w6IHsgY29udHJvbD86IGFueSwgY29sSW5kZXg/OiBudW1iZXIsIGNDb250cm9sSW5kZXg/OiBudW1iZXIgfSA9IHt9O1xuXG4gICAgICAgIGxldCBjb2xJbmRleCA9IDA7XG4gICAgICAgIGNvbHVtbnMuZm9yRWFjaChjb2x1bW4gPT4ge1xuICAgICAgICAgICAgaWYgKCFDb2xsZWN0aW9uVXRpbHMuaXNFbXB0eShjb2x1bW4uZmllbGRzKSAmJiBDb2xsZWN0aW9uVXRpbHMuaXNFbXB0eShjb250cm9sLmNvbnRyb2wpKSB7XG4gICAgICAgICAgICAgICAgbGV0IGNDb250cm9sSW5kZXggPSAwO1xuICAgICAgICAgICAgICAgIGNvbHVtbi5maWVsZHMuZm9yRWFjaChmaWVsZCA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChDb2xsZWN0aW9uVXRpbHMuaXNFbXB0eShjb250cm9sLmNvbnRyb2wpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sID0gTGlzdFV0aWxzLmdldEZpZWxkQ29udHJvbChmaWVsZCwgY29udHJvbEtleSwgY29sSW5kZXgsIGNDb250cm9sSW5kZXgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY0NvbnRyb2xJbmRleCsrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbEluZGV4Kys7XG4gICAgICAgIH0pXG5cbiAgICAgICAgcmV0dXJuIGNvbnRyb2w7XG4gICAgfVxuXG4gICAgc3RhdGljIGdldEZpZWxkQ29udHJvbChmaWVsZDogYW55LCBjb250cm9sS2V5OiBzdHJpbmcsIGNvbEluZGV4OiBudW1iZXIsIGNDb250cm9sSW5kZXg6IG51bWJlcik6IHsgY29udHJvbD86IGFueSwgY29sSW5kZXg/OiBudW1iZXIsIGNDb250cm9sSW5kZXg/OiBudW1iZXIgfSB7XG4gICAgICAgIGxldCBjb250cm9sOiB7IGNvbnRyb2w/OiBhbnksIGNvbEluZGV4PzogbnVtYmVyLCBjQ29udHJvbEluZGV4PzogbnVtYmVyIH0gPSB7fTtcblxuICAgICAgICBpZiAoZmllbGQua2V5ID09IGNvbnRyb2xLZXkpIHtcbiAgICAgICAgICAgIGNvbnRyb2wuY29udHJvbCA9IGZpZWxkO1xuICAgICAgICAgICAgY29udHJvbC5jb2xJbmRleCA9IGNvbEluZGV4O1xuICAgICAgICAgICAgY29udHJvbC5jQ29udHJvbEluZGV4ID0gY0NvbnRyb2xJbmRleDtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiMTExMTExMVwiKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGNvbnRyb2wpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGNvbnRyb2w7XG4gICAgfVxuXG4gICAgc3RhdGljIGdldEJ1dHRvbkNvbnRyb2woYnV0dG9uczogQXJyYXk8QnV0dG9uPiwgY29udHJvbEtleTogc3RyaW5nKTogYW55IHtcbiAgICAgICAgbGV0IGNvbnRyb2w6IGFueTtcblxuICAgICAgICBidXR0b25zLmZvckVhY2goYnV0dG9uID0+IHtcbiAgICAgICAgICAgIGlmIChidXR0b24uaWRlbnRpZmllciA9PSBjb250cm9sS2V5KSB7XG4gICAgICAgICAgICAgICAgY29udHJvbCA9IGJ1dHRvbjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcblxuICAgICAgICByZXR1cm4gY29udHJvbDtcbiAgICB9XG59Il19